

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Inelastica.Phonons &mdash; Inelastica |release| documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Inelastica |release| documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Inelastica
          

          
            
            <img src="../../_static/82px-Inelastica-logo-mini.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.3.0-10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more.html">More documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Publications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications using Inelastica</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Inelastica</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>Inelastica.Phonons</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Inelastica.Phonons</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A completely rewritten Phonons.py script with various improvements</span>
<span class="sd">and additional flexibility:</span>

<span class="sd">* The dynamic atoms no longer need to be a complete range(FCfirst,FClast+1).</span>
<span class="sd">  Any arbitrary list of atoms (options.DynamicAtoms) can now be specified.</span>

<span class="sd">* The displacement amplitude in the various FCrun and OSrun directories</span>
<span class="sd">  may correspond to different values.</span>

<span class="sd">* The code accepts that some atoms may have been displaced in several FCrun directories.</span>
<span class="sd">  Only the first instance (first FCrun directory) encountered is read/used.</span>

<span class="sd">* The auxiliary NetCDF file has been eliminated by simply interchanging </span>
<span class="sd">  the loops over gradients and phonon modes. Thus, only one gradient</span>
<span class="sd">  need to be present in the memory at one time.</span>

<span class="sd">Thomas Frederiksen, August 2014</span>

<span class="sd">Additional improvements to facilitate large-scale calcuations:</span>

<span class="sd">* The code allows to specify the range of dynamic atoms for which the </span>
<span class="sd">  electron-phonon coupling elements are evaluated (flags:--EPHfirst,--EPHlast)</span>

<span class="sd">* It is possible to restart the code (flag:--Restart) by using the NetCDF output obtained </span>
<span class="sd">  from a previous calculation as checkpoint file (flag:--CheckPointNetCDF)</span>

<span class="sd">* The matrix of electron-phonon coupling elements can be evaluated in </span>
<span class="sd">  single precision to reduce disk space usage (flag:--SinglePrec).</span>

<span class="sd">Daniele Stradi, April 2015</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">Inelastica.io.siesta</span> <span class="kn">as</span> <span class="nn">SIO</span>
<span class="kn">import</span> <span class="nn">Inelastica.Symmetry</span> <span class="kn">as</span> <span class="nn">Symmetry</span>
<span class="kn">import</span> <span class="nn">Inelastica.CommonFunctions</span> <span class="kn">as</span> <span class="nn">CF</span>
<span class="kn">import</span> <span class="nn">Inelastica.MakeGeom</span> <span class="kn">as</span> <span class="nn">MG</span>
<span class="kn">import</span> <span class="nn">Inelastica.physics.constants</span> <span class="kn">as</span> <span class="nn">PC</span>
<span class="kn">import</span> <span class="nn">Inelastica.MiscMath</span> <span class="kn">as</span> <span class="nn">MM</span>
<span class="kn">import</span> <span class="nn">Inelastica.ValueCheck</span> <span class="kn">as</span> <span class="nn">VC</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">NC4</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">LA</span>
<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">string</span>

<div class="viewcode-block" id="GetOptions"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.GetOptions">[docs]</a><span class="k">def</span> <span class="nf">GetOptions</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># if text string is specified, convert to list</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span><span class="n">VC</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Methods to calculate vibrations and e-ph couplings from SIESTA output&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;DestDir&#39;</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Destination directory&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span><span class="s1">&#39;--CalcCoupl&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;CalcCoupl&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Calculate e-ph couplings [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span><span class="s1">&#39;--Restart&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Restart&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Restart from a previous run [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--CheckPointNetCDF&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;CheckPointNetCDF&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Old NetCDF file used for restart [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span><span class="s1">&#39;--SinglePrec&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;SinglePrec&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Calculate e-ph couplings using single precision arrays [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-F&#39;</span><span class="p">,</span><span class="s1">&#39;--DeviceFirst&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DeviceFirst&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;First device atom index (in the electronic basis) [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-L&#39;</span><span class="p">,</span><span class="s1">&#39;--DeviceLast&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DeviceLast&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Last device atom index (in the electronic basis) [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--FCfirst&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;FCfirst&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;First FC atom index [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--FClast&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;FClast&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Last FC atom index [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--EPHfirst&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;EPHfirst&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;First atom index for which the e-ph. couplings are evaluated [default=FCfirst]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--EPHlast&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;EPHlast&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Last atom index for which the e-ph. couplings are evaluated [default=FClast]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--PBCFirst&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;PBCFirst&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;For eliminating interactions through periodic boundary conditions in z-direction [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--PBCLast&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;PBCLast&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;For eliminating interactions through periodic boundary conditions in z-direction [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--FCwildcard&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;FCwildcard&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;./FC*&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Wildcard for FC directories [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--OSdir&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;onlySdir&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;./OSrun&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Location of OnlyS directory [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span><span class="s1">&#39;--AbsoluteEnergyReference&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;AbsEref&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use an absolute energy reference (Fermi energy of equilibrium structure) for displaced Hamiltonians (e.g., when eF is not well-defined) instead of the instantaneous Fermi energy for the displaced geometries, cf. Eq.(17) in PRB 75, 205413 (2007) [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span><span class="s1">&#39;--Isotopes&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;Isotopes&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;[]&#39;</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;String, formatted as a list [[i1,m1],...], where the mass of atom index i1 (SIESTA numbering) will be set to m1. Alternatively, the argument can be a file with the string [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span><span class="s1">&#39;--k1&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;k1&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;k-point along a1 where e-ph couplings are evaluated [</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span><span class="s1">&#39;--k2&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;k2&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;k-point along a2 where e-ph couplings are evaluated [</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span><span class="s1">&#39;--k3&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;k3&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;k-point along a3 where e-ph couplings are evaluated [</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span><span class="s1">&#39;--WriteGradients&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s1">&#39;WriteGradients&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Write real-space gradients dH/dR to NetCDF [default=</span><span class="si">%(default)s</span><span class="s1">]&#39;</span><span class="p">)</span>
    
    <span class="n">options</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

    <span class="c1"># With this one can overwrite the logging information</span>
    <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">Logfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">Logfile</span> <span class="o">=</span> <span class="s1">&#39;Phonons.log&#39;</span>

    <span class="c1"># k-point</span>
    <span class="n">options</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">options</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">k3</span><span class="p">],</span><span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">options</span><span class="o">.</span><span class="n">k1</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">k2</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">k3</span>

    <span class="c1"># Determine array type for H,S,dH,...</span>
    <span class="n">options</span><span class="o">.</span><span class="n">GammaPoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">kpoint</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-7</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">GammaPoint</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">SinglePrec</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">atype</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">float32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">atype</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">SinglePrec</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">atype</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">complex64</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">atype</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">complex128</span>
    
    <span class="c1"># Dynamic atoms</span>
    <span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FCfirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">FClast</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
 
    <span class="c1"># EPH atoms - set only different from options.DynamicAtoms if a subset is specified</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">EPHfirst</span><span class="o">&gt;=</span><span class="n">options</span><span class="o">.</span><span class="n">FCfirst</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">EPHlast</span><span class="o">&lt;=</span><span class="n">options</span><span class="o">.</span><span class="n">FClast</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">EPHAtoms</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">EPHfirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">EPHlast</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">EPHAtoms</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span>
    <span class="k">del</span> <span class="n">options</span><span class="o">.</span><span class="n">EPHfirst</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">EPHlast</span>
    <span class="k">del</span> <span class="n">options</span><span class="o">.</span><span class="n">FCfirst</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">FClast</span>

    <span class="c1"># PBCFirst/PBCLast</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">PBCFirst</span><span class="o">&lt;</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceFirst</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">PBCFirst</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">DeviceFirst</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">PBCLast</span><span class="o">&gt;</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceLast</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">PBCLast</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">DeviceLast</span>

    <span class="c1"># Isotopes specified in separate file?</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">options</span></div>
  

<div class="viewcode-block" id="FCrun"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.FCrun">[docs]</a><span class="k">class</span> <span class="nc">FCrun</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">runfdf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdf</span> <span class="o">=</span> <span class="n">runfdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">runfdf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="s1">&#39;SystemLabel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
        <span class="n">FCfirst</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="s1">&#39;MD.FCfirst&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
        <span class="n">FClast</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="s1">&#39;MD.FClast&#39;</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
        <span class="c1"># Finite-displacement amplitude</span>
        <span class="n">ampl</span><span class="p">,</span><span class="n">unit</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFline</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="n">KeyWord</span><span class="o">=</span><span class="s1">&#39;MD.FCDispl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;ANG&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ampl</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unit</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;BOHR&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ampl</span><span class="p">)</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
        <span class="k">print</span> <span class="s1">&#39;Displacement = </span><span class="si">%.6f</span><span class="s1"> Ang&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">Displ</span>
        <span class="c1"># Read geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">runfdf</span><span class="p">)</span>
        <span class="c1"># Compare with XV file corrected for last displacement</span>
        <span class="n">XV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">.XV&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span>
        <span class="n">geomXV</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XV</span><span class="p">)</span>
        <span class="n">geomXV</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">FClast</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">geomXV</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: Geometries </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> should differ ONLY by displacement of atom </span><span class="si">%s</span><span class="s1"> in z&#39;</span>\
                     <span class="o">%</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="n">XV</span><span class="p">,</span><span class="n">FClast</span><span class="p">))</span>
        <span class="c1"># Set up FC[i,a,j,b]: Force constant (eV/A^2) from moved atom i, axis a to atom j, axis b</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SIO</span><span class="o">.</span><span class="n">ReadFCFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">.FC&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">natoms</span><span class="p">:(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">natoms</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">natoms</span><span class="p">:(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">natoms</span><span class="p">]</span>
        <span class="c1"># Correct force constants for the moved atom</span>
        <span class="c1"># Cf. Eq. (13) in Frederiksen et al. PRB 75, 205413 (2007)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Determine TSHS files</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">*.TSHS&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span><span class="p">)</span>
        <span class="n">files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Phonons.GetFileLists: WARNING - Inconsistent number of *.TSHS files in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">FCfirst</span><span class="p">,</span><span class="n">FClast</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Build dictionary over TSHS files and corresponding displacement amplitudes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Equilibrium TSHS</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Shifted TSHS files (atom,axis,direction)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="FCrun.GetOrbitalIndices"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.FCrun.GetOrbitalIndices">[docs]</a>    <span class="k">def</span> <span class="nf">GetOrbitalIndices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Determine snr (siesta number) for each label</span>
        <span class="n">csl</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFblock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdf</span><span class="p">,</span> <span class="n">KeyWord</span> <span class="o">=</span> <span class="s1">&#39;ChemicalSpeciesLabel&#39;</span><span class="p">)</span>
        <span class="n">csl2snr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">set</span> <span class="ow">in</span> <span class="n">csl</span><span class="p">:</span>
            <span class="n">csl2snr</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Determine nao (number of orbitals) for each snr</span>
        <span class="n">ionNCfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/*.ion.nc*&#39;</span><span class="p">)</span>
        <span class="n">snr2nao</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ionfile</span> <span class="ow">in</span> <span class="n">ionNCfiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ionfile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
                <span class="k">print</span> <span class="s1">&#39;Phonons.GetOrbitalIndices: Unzipping&#39;</span><span class="p">,</span><span class="n">ionfile</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;gunzip &#39;</span><span class="o">+</span><span class="n">ionfile</span><span class="p">)</span>
                <span class="n">ionfile</span> <span class="o">=</span> <span class="n">ionfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">ionfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">thissnr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">csl2snr</span><span class="p">[</span><span class="nb">file</span><span class="o">.</span><span class="n">Label</span><span class="p">])</span>
            <span class="n">snr2nao</span><span class="p">[</span><span class="n">thissnr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">Number_of_orbitals</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s1">&#39;Phonons.GetOrbitalIndices: Dictionary snr2nao =&#39;</span><span class="p">,</span><span class="n">snr2nao</span>
        <span class="c1"># Determine which orbital indices that belongs to a certain atom</span>
        <span class="n">orbitalIndices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmpOrb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">snr</span><span class="p">:</span>
            <span class="n">nao</span> <span class="o">=</span> <span class="n">snr2nao</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
            <span class="n">orbitalIndices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tmpOrb</span><span class="p">,</span><span class="n">tmpOrb</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">nao</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tmpOrb</span><span class="o">+=</span><span class="n">nao</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitalIndices</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orbitalIndices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nao</span> <span class="o">=</span> <span class="n">tmpOrb</span> <span class="c1"># total number of orbitals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snr2nao</span> <span class="o">=</span> <span class="n">snr2nao</span> <span class="c1"># orbitals per species</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbitalIndices</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nao</span></div></div>


<div class="viewcode-block" id="OTSrun"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.OTSrun">[docs]</a><span class="k">class</span> <span class="nc">OTSrun</span><span class="p">(</span><span class="n">FCrun</span><span class="p">):</span> <span class="c1"># Only TranSiesta run</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">runfdf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdf</span> <span class="o">=</span> <span class="n">runfdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">runfdf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">runfdf</span><span class="p">,</span><span class="s1">&#39;SystemLabel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
        <span class="c1"># Read geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">runfdf</span><span class="p">)</span>
        <span class="c1"># Compare with XV file corrected for last displacement</span>
        <span class="n">XV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">.XV&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span>
        <span class="n">geomXV</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">(</span><span class="n">XV</span><span class="p">)</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span>
        <span class="c1"># Determine TSHS files</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">*.TSHS&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">systemlabel</span><span class="p">)</span>
        <span class="c1"># Build dictionary over TSHS files and corresponding displacement amplitudes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Equilibrium TSHS</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Phonons.GetFileLists: No TSHS file found in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="OSrun"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.OSrun">[docs]</a><span class="k">class</span> <span class="nc">OSrun</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">onlySdir</span><span class="p">,</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;Phonons.GetOnlyS: Reading from&#39;</span><span class="p">,</span> <span class="n">onlySdir</span>
        <span class="n">onlySfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">onlySdir</span><span class="o">+</span><span class="s1">&#39;/*.onlyS*&#39;</span><span class="p">)</span>
        <span class="n">onlySfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlySfiles</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Phonons.GetOnlyS: No .onlyS file found!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlySfiles</span><span class="p">)</span><span class="o">!=</span><span class="mi">6</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Phonons.GetOnlyS: Wrong number of onlyS files found!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">onlyS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">Displ</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">onlySfiles</span><span class="p">:</span>
                <span class="n">thisHS</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
                <span class="n">thisHS</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="n">atype</span><span class="p">)</span>
                <span class="n">S</span> <span class="o">=</span> <span class="n">thisHS</span><span class="o">.</span><span class="n">S</span>
                <span class="k">del</span> <span class="n">thisHS</span>
                <span class="n">nao</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">S0</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nao</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">nao</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">dmat</span><span class="o">=</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">:</span><span class="n">nao</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_1.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
                <span class="k">elif</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_2.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
                <span class="k">elif</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_3.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
                <span class="k">elif</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_4.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
                <span class="k">elif</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_5.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
                <span class="k">elif</span> <span class="nb">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_6.onlyS&#39;</span><span class="p">):</span>
                    <span class="n">onlyS</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmat</span>
            <span class="c1"># Loop over the 6 doubled geometries and determine the displacement</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
                <span class="n">thisd</span> <span class="o">=</span> <span class="mf">1e10</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SIO</span><span class="o">.</span><span class="n">Getxyz</span><span class="p">(</span><span class="n">onlySdir</span><span class="o">+</span><span class="s1">&#39;/RUN_</span><span class="si">%i</span><span class="s1">.fdf&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
                    <span class="n">thisd</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">thisd</span><span class="p">,(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span><span class="o">**.</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">Displ</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">thisd</span>
                <span class="k">print</span> <span class="s1">&#39;Phonons.GetOnlyS: OnlyS-displacement (min) = </span><span class="si">%.5f</span><span class="s1"> Ang&#39;</span><span class="o">%</span><span class="n">thisd</span>
            <span class="c1"># Construct dS array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S0</span> <span class="o">=</span> <span class="n">S0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dS</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,)</span><span class="o">+</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dmat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">onlyS</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">onlyS</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">Displ</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Displ</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span> <span class="o">=</span> <span class="n">Displ</span></div>

<div class="viewcode-block" id="DynamicalMatrix"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix">[docs]</a><span class="k">class</span> <span class="nc">DynamicalMatrix</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fdfs</span><span class="p">,</span><span class="n">DynamicAtoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">TSrun</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdfs</span> <span class="o">=</span> <span class="n">fdfs</span>
        <span class="k">if</span> <span class="n">TSrun</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span> <span class="o">=</span> <span class="p">[</span><span class="n">OTSrun</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fdfs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span> <span class="o">=</span> <span class="p">[</span><span class="n">FCrun</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fdfs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geom</span> <span class="c1"># assume identical geometries</span>
        <span class="k">if</span> <span class="n">DynamicAtoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetDynamicAtoms</span><span class="p">(</span><span class="n">DynamicAtoms</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicalMatrix.SetDynamicAtoms"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.SetDynamicAtoms">[docs]</a>    <span class="k">def</span> <span class="nf">SetDynamicAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">DynamicAtoms</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span> <span class="o">=</span> <span class="n">DynamicAtoms</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DynamicAtoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NN</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NN</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DynamicAtoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fcr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fcr</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s1">&#39;Reading FC data for dynamic atom </span><span class="si">%i</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">fcr</span><span class="o">.</span><span class="n">fdf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Displ</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">Displ</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcr</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="c1"># Check that we really found the required atom</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Displ</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: Did not find FC data for a dynamic atom </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span></div>

<div class="viewcode-block" id="DynamicalMatrix.SetMasses"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.SetMasses">[docs]</a>    <span class="k">def</span> <span class="nf">SetMasses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Isotopes</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Masses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Set default masses</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">PC</span><span class="o">.</span><span class="n">AtomicMass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;WARNING: Mass of atom </span><span class="si">%i</span><span class="s1"> unknown, set arbitrarily to 1000.00 amu&#39;</span><span class="o">%</span><span class="n">v</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">1000.00</span> <span class="p">)</span>
        <span class="c1"># Override with specified masses?</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">mass</span> <span class="ow">in</span> <span class="n">Isotopes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;Phonons.Analyse: Setting mass for atom </span><span class="si">%i</span><span class="s1"> (SIESTA numbering) to </span><span class="si">%f</span><span class="s1">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">mass</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass</span></div>

<div class="viewcode-block" id="DynamicalMatrix.ApplySumRule"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.ApplySumRule">[docs]</a>    <span class="k">def</span> <span class="nf">ApplySumRule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">FC</span><span class="p">):</span>
        <span class="n">FC0</span> <span class="o">=</span> <span class="n">FC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Correct force constants for the moved atom</span>
        <span class="c1"># Cf. Eq. (13) in Frederiksen et al. PRB 75, 205413 (2007)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">FC</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">FC</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FC</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;Total sumrule change in FC: </span><span class="si">%.3e</span><span class="s1"> eV/Ang&#39;</span> <span class="o">%</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">FC0</span><span class="p">)</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">FC</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FC</span></div>

<div class="viewcode-block" id="DynamicalMatrix.ComputePhononModes"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.ComputePhononModes">[docs]</a>    <span class="k">def</span> <span class="nf">ComputePhononModes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">FC</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">)</span>
        <span class="n">FCtilde</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dyn</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">dyn</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="c1"># Symmetrize and mass-scale</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
                <span class="n">FCtilde</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">FC</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">+</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="n">FC</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>\
                                   <span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1"># Solve eigenvalue problem with symmetric FCtilde</span>
        <span class="n">FCtilde</span> <span class="o">=</span> <span class="n">FCtilde</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FCtilde</span> <span class="o">=</span> <span class="n">FCtilde</span>
        <span class="n">evalue</span><span class="p">,</span><span class="n">evec</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">FCtilde</span><span class="p">)</span>
        <span class="c1">#evalue,evec = LA.eig(FCtilde)</span>
        <span class="n">evec</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">evec</span><span class="p">)</span>
        <span class="n">evalue</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">evalue</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="c1"># Calculate frequencies</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">hbar2SI</span><span class="o">*</span><span class="p">(</span><span class="mf">1e20</span><span class="o">/</span><span class="p">(</span><span class="n">PC</span><span class="o">.</span><span class="n">eV2Joule</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">amu2kg</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">const</span><span class="o">*</span><span class="n">evalue</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># Units in eV</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
            <span class="c1"># Real eigenvalues are defined as positive, imaginary eigenvalues as negative</span>
            <span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="o">.</span><span class="n">real</span>
        <span class="c1"># Normalize eigenvectors</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">evec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
            <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># Sort in order descending mode energies</span>
        <span class="c1">#hw = hw[::-1] # reverse array</span>
        <span class="c1">#U = U[::-1] # reverse array</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">hw</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverse</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>
        <span class="c1"># Print mode frequencies</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Phonons.CalcPhonons: Frequencies in meV:&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="mi">9</span><span class="p">),</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">print</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span> <span class="k">print</span>
        <span class="c1">#print &#39;Phonons.CalcPhonons: Frequencies in cm^-1:&#39;</span>
        <span class="c1">#for i in range(3*dyn):</span>
        <span class="c1">#    print string.rjust(&#39;%.3f&#39;%(hw[i]/PC.invcm2eV),9),</span>
        <span class="c1">#    if (i-5)%6==0: print</span>
        <span class="c1">#if (i-5)%6!=0: print</span>

        <span class="c1"># Compute real displacement vectors</span>
        <span class="n">Udisp</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
            <span class="c1"># Eigenvectors after division by sqrt(mass)</span>
            <span class="n">Udisp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span><span class="o">**.</span><span class="mi">5</span>

        <span class="c1"># Compute displacement vectors scaled for the characteristic length</span>
        <span class="n">Ucl</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dyn</span><span class="p">):</span>
                <span class="c1"># Eigenvectors after multiplication by characteristic length</span>
                <span class="k">if</span> <span class="n">hw</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">Ucl</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">hw</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="p">)))</span><span class="o">**.</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Characteristic length not defined for non-postive frequency</span>
                    <span class="n">Ucl</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">0.0</span>

        <span class="c1"># Expand vectors to full geometry</span>
        <span class="n">UU</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">UUdisp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="n">UUcl</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">):</span>
                <span class="n">UU</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">UUdisp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Udisp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="n">Udisp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Udisp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">UUcl</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ucl</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="n">Ucl</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Ucl</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Udisp</span> <span class="o">=</span> <span class="n">Udisp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ucl</span> <span class="o">=</span> <span class="n">Ucl</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">UU</span> <span class="o">=</span> <span class="n">UU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UUdisp</span> <span class="o">=</span> <span class="n">UUdisp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UUcl</span> <span class="o">=</span> <span class="n">UUcl</span></div>

<div class="viewcode-block" id="DynamicalMatrix.PrepareGradients"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.PrepareGradients">[docs]</a>    <span class="k">def</span> <span class="nf">PrepareGradients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">onlySdir</span><span class="p">,</span><span class="n">kpoint</span><span class="p">,</span><span class="n">DeviceFirst</span><span class="p">,</span><span class="n">DeviceLast</span><span class="p">,</span><span class="n">AbsEref</span><span class="p">,</span><span class="n">atype</span><span class="p">,</span><span class="n">TSrun</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Phonons.PrepareGradients: Setting up various arrays&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atype</span> <span class="o">=</span> <span class="n">atype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">kpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">,</span><span class="n">nao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FCRs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetOrbitalIndices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="n">atype</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">TSrun</span><span class="p">:</span>
            <span class="n">OS</span> <span class="o">=</span> <span class="n">OSrun</span><span class="p">(</span><span class="n">onlySdir</span><span class="p">,</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="n">atype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dS</span> <span class="o">=</span> <span class="n">OS</span><span class="o">.</span><span class="n">dS</span>
            <span class="c1"># OS.S0 and TSHS0.S should be identical, but with some versions/compilations</span>
            <span class="c1"># of TranSIESTA this is NOT always the case away from k=0 (GammaPoint is OK).</span>
            <span class="c1"># It appears to be a bug in TranSIESTA 3.2 and 4.0b affecting runs</span>
            <span class="c1"># with TS.onlyS=True, i.e., the quick evaluations in the OSrun folder</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">OS</span><span class="o">.</span><span class="n">S0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Inconsistency detected with your .onlyS files. Perhaps a bug in your TranSIESTA version/compilation.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invS0H0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="c1">#invS0 = LA.inv(OS.S0) # &lt;--- This choice was used in rev. 324-397</span>
        <span class="n">invS0</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Reverting to the matrix used up to rev. 323</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iSpin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invS0H0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">iSpin</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">invS0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">iSpin</span><span class="p">,:,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invS0H0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">iSpin</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">iSpin</span><span class="p">,:,:],</span><span class="n">invS0</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">invS0</span>
        <span class="c1"># don&#39;t re-create the array every time... too expensive    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dSdij</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span><span class="n">atype</span><span class="p">)</span>
        
        <span class="c1"># Take Device region </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">DeviceFirst</span><span class="p">,</span><span class="n">DeviceLast</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">first</span><span class="p">,</span><span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="n">DeviceFirst</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="n">DeviceLast</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">H</span><span class="p">[:,</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">S</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeviceFirst</span> <span class="o">=</span> <span class="n">DeviceFirst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeviceLast</span> <span class="o">=</span> <span class="n">DeviceLast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AbsEref</span> <span class="o">=</span> <span class="n">AbsEref</span></div>
        
<div class="viewcode-block" id="DynamicalMatrix.GetGradient"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.GetGradient">[docs]</a>    <span class="k">def</span> <span class="nf">GetGradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Atom</span><span class="p">,</span><span class="n">Axis</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Phonons.GetGradient: Computing dH[</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Atom</span><span class="p">,</span><span class="n">Axis</span><span class="p">)</span>
        <span class="c1"># Read TSHS files</span>
        <span class="n">TSHSm</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">Atom</span><span class="p">,</span><span class="n">Axis</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">TSHSm</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">)</span>
        <span class="n">TSHSp</span> <span class="o">=</span> <span class="n">SIO</span><span class="o">.</span><span class="n">HS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS</span><span class="p">[</span><span class="n">Atom</span><span class="p">,</span><span class="n">Axis</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">TSHSp</span><span class="o">.</span><span class="n">setkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span><span class="n">atype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">)</span>
        <span class="c1"># Use Fermi energy of equilibrium calculation as energy reference?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">AbsEref</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Computing gradient with absolute energy reference&#39;</span>
            <span class="k">for</span> <span class="n">iSpin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">):</span>
                <span class="n">TSHSm</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">iSpin</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">TSHSm</span><span class="o">.</span><span class="n">ef</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">ef</span><span class="p">)</span><span class="o">*</span><span class="n">TSHSm</span><span class="o">.</span><span class="n">S</span>
                <span class="n">TSHSp</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">iSpin</span><span class="p">,:,:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">TSHSp</span><span class="o">.</span><span class="n">ef</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">TSHS0</span><span class="o">.</span><span class="n">ef</span><span class="p">)</span><span class="o">*</span><span class="n">TSHSp</span><span class="o">.</span><span class="n">S</span>
        <span class="c1"># Compute direct gradient</span>
        <span class="n">dH</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHSp</span><span class="o">.</span><span class="n">H</span><span class="o">-</span><span class="n">TSHSm</span><span class="o">.</span><span class="n">H</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Displ</span><span class="p">[</span><span class="n">Atom</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">TSHSm</span><span class="p">,</span> <span class="n">TSHSp</span>
        <span class="c1"># Orbital range for the displaced atom:</span>
        <span class="n">f</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="n">Atom</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dSdij</span><span class="p">[:,</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dS</span><span class="p">[</span><span class="n">Axis</span><span class="p">,:,</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Apply Pulay-type corrections</span>
        <span class="k">for</span> <span class="n">iSpin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">):</span>
            <span class="n">dH</span><span class="p">[</span><span class="n">iSpin</span><span class="p">,:,:]</span> <span class="o">-=</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">MM</span><span class="o">.</span><span class="n">dagger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dSdij</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">invS0H0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">iSpin</span><span class="p">,:,:])</span> \
                             <span class="o">+</span> <span class="n">MM</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invS0H0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">iSpin</span><span class="p">,:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">dSdij</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dSdij</span><span class="p">[:,</span><span class="n">f</span><span class="p">:</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># reset</span>
        <span class="k">return</span> <span class="n">dH</span></div>

<div class="viewcode-block" id="DynamicalMatrix.ComputeEPHcouplings"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.ComputeEPHcouplings">[docs]</a>    <span class="k">def</span> <span class="nf">ComputeEPHcouplings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PBCFirst</span><span class="p">,</span><span class="n">PBCLast</span><span class="p">,</span><span class="n">EPHAtoms</span><span class="p">,</span><span class="n">Restart</span><span class="p">,</span><span class="n">CheckPointNetCDF</span><span class="p">,</span><span class="n">WriteGradients</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">first</span><span class="p">,</span><span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceFirst</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceLast</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rednao</span> <span class="o">=</span> <span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">first</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">hbar2SI</span><span class="o">*</span><span class="p">(</span><span class="mf">1e20</span><span class="o">/</span><span class="p">(</span><span class="n">PC</span><span class="o">.</span><span class="n">eV2Joule</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">amu2kg</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">Restart</span><span class="p">:</span>
              <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CheckPointNetCDF</span><span class="p">):</span>
                 <span class="k">print</span> <span class="s2">&quot;ERROR!!! You have enforced a restart but you have not provided any checkpoint NetCDF file!&quot;</span>
                 <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
              <span class="k">else</span><span class="p">:</span>
                 <span class="k">print</span> <span class="s2">&quot;Restart e-ph. calculation. Partial information read from file:&quot;</span><span class="p">,</span> <span class="n">CheckPointNetCDF</span>
                 <span class="n">RNCfile</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">CheckPointNetCDF</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                 <span class="n">Heph</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RNCfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;He_ph&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">print</span> <span class="s2">&quot;Start e-ph. calculation from scratch&quot;</span>
           <span class="n">Heph</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">,</span><span class="n">rednao</span><span class="p">,</span><span class="n">rednao</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">WriteGradients</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop over dynamic atoms</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">EPHAtoms</span><span class="p">):</span>
            <span class="c1"># Loop over axes</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Compute gradient</span>
                <span class="n">dH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetGradient</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="c1"># Remove Periodic Boundary terms</span>
                <span class="n">nuo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dH</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pbcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="n">PBCFirst</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pbcl</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OrbIndx</span><span class="p">[</span><span class="n">PBCLast</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">PBCFirst</span><span class="p">:</span>
                    <span class="c1"># we have something to remove...</span>
                    <span class="k">print</span> <span class="s1">&#39;Warning: Setting certain elements in dH[</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">] to zero because </span><span class="si">%i</span><span class="s1">&lt;PBCFirst&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                    <span class="c1">#bb = (PBCFirst - FCfirst) * 3</span>
                    <span class="n">dH</span><span class="p">[:,</span><span class="n">pbcl</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">nuo</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">dH</span><span class="p">[:,:,</span><span class="n">pbcl</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">nuo</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">PBCLast</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;Warning: Setting certain elements in dH[</span><span class="si">%i</span><span class="s1">,</span><span class="si">%i</span><span class="s1">] to zero because PBCLast&lt;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                    <span class="c1">#aa = (PBCLast - FCfirst) * 3</span>
                    <span class="n">dH</span><span class="p">[:,:</span><span class="n">pbcf</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">dH</span><span class="p">[:,:,:</span><span class="n">pbcf</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1"># Device part</span>
                <span class="n">dh</span> <span class="o">=</span> <span class="n">dH</span><span class="p">[:,</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">WriteGradients</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dh</span><span class="p">)</span>
                <span class="c1"># Loop over modes and throw away the gradient (to save memory)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Eigenvectors should be real for GammaPoint phonons, hence we always take the real part</span>
                        <span class="n">Heph</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">const</span><span class="o">*</span><span class="n">dh</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">UU</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">hw</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">**.</span><span class="mi">5</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Print only first time</span>
                        <span class="k">print</span> <span class="s1">&#39;Phonons.ComputeEPHcouplings: Mode </span><span class="si">%i</span><span class="s1"> has nonpositive frequency --&gt; Zero-valued coupling matrix&#39;</span><span class="o">%</span><span class="n">m</span>
                        <span class="c1"># already zero</span>
        <span class="k">del</span> <span class="n">dH</span><span class="p">,</span> <span class="n">dh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heph</span> <span class="o">=</span> <span class="n">Heph</span>
        <span class="k">if</span> <span class="n">WriteGradients</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="p">)</span></div>

<div class="viewcode-block" id="DynamicalMatrix.WriteOutput"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.DynamicalMatrix.WriteOutput">[docs]</a>    <span class="k">def</span> <span class="nf">WriteOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">SinglePrec</span><span class="p">,</span><span class="n">GammaPoint</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Phonons.WriteOutput&#39;</span>
        <span class="c1">### Write MKL- and xyz-files</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw</span>
        <span class="c1"># Write only real part of eigenvectors</span>
        <span class="n">UU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UU</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> 
        <span class="n">UUdisp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UUdisp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">UUcl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UUcl</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        
        <span class="n">SIO</span><span class="o">.</span><span class="n">WriteMKLFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mkl&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UU</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">SIO</span><span class="o">.</span><span class="n">WriteMKLFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.real-displ.mkl&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UUdisp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">SIO</span><span class="o">.</span><span class="n">WriteXYZFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.xyz&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">WriteFreqFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.freq&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="n">hw</span><span class="p">)</span>
        <span class="n">WriteVibDOSFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.Gfdos&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">)</span>
        <span class="n">WriteVibDOSFile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.Lfdos&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Lorentzian&#39;</span><span class="p">)</span>
        <span class="n">WriteAXSFFiles</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mol.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UU</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">WriteAXSFFiles</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mol.real-displ.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UUdisp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">WriteAXSFFiles</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mol.charlength-displ.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UUcl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">WriteAXSFFilesPer</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.per.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">UU</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">WriteAXSFFilesPer</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.per.real-displ.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span>\
                             <span class="n">hw</span><span class="p">,</span><span class="n">UUdisp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">WriteAXSFFilesPer</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.per.charlength-displ.axsf&#39;</span><span class="o">%</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">pbc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span><span class="p">,</span>\
                             <span class="n">hw</span><span class="p">,</span><span class="n">UUcl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>
        <span class="c1"># Netcdf format</span>
        <span class="n">ncdffn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.nc&#39;</span><span class="o">%</span><span class="n">label</span>
        <span class="k">print</span> <span class="s1">&#39;Phonons.WriteOutput: Writing&#39;</span><span class="p">,</span><span class="n">ncdffn</span>
        <span class="n">ncdf</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">ncdffn</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;one&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;natoms&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;dyn_atoms&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;hw&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;hw&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">hw</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;hw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Phonon frequencies&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;hw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;natoms&#39;</span><span class="p">,</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UU</span><span class="o">.</span><span class="n">real</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of the phonon eigenvectors&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Udisp&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;natoms&#39;</span><span class="p">,</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Udisp&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UUdisp</span><span class="o">.</span><span class="n">real</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Udisp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of the phonon displacement vectors&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Ucl&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;natoms&#39;</span><span class="p">,</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Ucl&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UUcl</span><span class="o">.</span><span class="n">real</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Ucl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of displacement vectors scaled for the characteristic length&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CellVectors&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;CellVectors&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">pbc</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;CellVectors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Unit cell vectors&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;CellVectors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Ang&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;GeometryXYZ&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;natoms&#39;</span><span class="p">,</span><span class="s1">&#39;xyz&#39;</span><span class="p">))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GeometryXYZ&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GeometryXYZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Atomic coordinates of all atoms in cell&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GeometryXYZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Ang&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;AtomNumbers&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,(</span><span class="s1">&#39;natoms&#39;</span><span class="p">,))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;AtomNumbers&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">anr</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;AtomNumbers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Element number for each atom (anr)&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;SpeciesNumbers&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,(</span><span class="s1">&#39;natoms&#39;</span><span class="p">,))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SpeciesNumbers&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">snr</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SpeciesNumbers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Siesta species number (snr)&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Masses&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;dyn_atoms&#39;</span><span class="p">,))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Masses&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Masses</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Masses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Atomic masses of each dynamic atom&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Masses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Atomic units&#39;</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;DynamicAtoms&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,(</span><span class="s1">&#39;dyn_atoms&#39;</span><span class="p">,))</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;DynamicAtoms&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DynamicAtoms</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;DynamicAtoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Dynamic atoms (SIESTA numbering)&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h0</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;dev_atoms&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;DeviceAtoms&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,(</span><span class="s1">&#39;dev_atoms&#39;</span><span class="p">,))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;DeviceAtoms&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeviceAtoms</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;DeviceAtoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Device atoms (SIESTA numbering)&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;kpoint&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;xyz&#39;</span><span class="p">,))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;kpoint&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;kpoint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Vector in orthogonal space (not in reciprocal space)&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;H0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">.</span><span class="n">real</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of electronic Hamiltonian&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;eV&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;S0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s0</span><span class="o">.</span><span class="n">real</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Electronic overlap matrix&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">GammaPoint</span><span class="p">:</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;H0.imag&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H0.imag&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;H0.imag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Imaginary part of Hamiltonian&#39;</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;S0.imag&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,(</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;S0.imag&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s0</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;S0.imag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Imaginary part of overlap&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;Phonons.WriteOutput: Wrote H and S to&#39;</span><span class="p">,</span><span class="n">ncdffn</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Hamiltonian etc not computed&#39;</span>
        <span class="c1"># Precision for He_ph (and gradients)</span>
        <span class="k">if</span> <span class="n">SinglePrec</span><span class="p">:</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">heph</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;He_ph&#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;He_ph&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heph</span><span class="o">.</span><span class="n">real</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;He_ph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of EPH couplings&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;He_ph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;eV/Ang&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">GammaPoint</span><span class="p">:</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ImHe_ph&#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImHe_ph&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heph</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;ImHe_ph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Imaginary part of EPH couplings&#39;</span>
            <span class="k">print</span> <span class="s1">&#39;Phonons.WriteOutput: Wrote He_ph to&#39;</span><span class="p">,</span><span class="n">ncdffn</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;EPH couplings etc not computed&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;grad.re&#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;grad.re&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">real</span>            
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;grad.re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Real part of gradients&#39;</span>
            <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;grad.re&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;eV/Ang&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">GammaPoint</span><span class="p">:</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;grad.im&#39;</span><span class="p">,</span><span class="n">atype</span><span class="p">,(</span><span class="s1">&#39;modes&#39;</span><span class="p">,</span><span class="s1">&#39;nspin&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">,</span><span class="s1">&#39;norb&#39;</span><span class="p">))</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;grad.im&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradients</span><span class="o">.</span><span class="n">imag</span>
                <span class="n">ncdf</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;grad.im&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;Imaginary part of gradients&#39;</span>         
            <span class="k">print</span> <span class="s1">&#39;Phonons.WriteOutput: Wrote gradients to&#39;</span><span class="p">,</span><span class="n">ncdffn</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">ncdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">print</span> <span class="s1">&#39;Phonons.WriteOutput: Finished&#39;</span><span class="p">,</span><span class="n">ncdffn</span></div></div>

<div class="viewcode-block" id="WriteFreqFile"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.WriteFreqFile">[docs]</a><span class="k">def</span> <span class="nf">WriteFreqFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">hw</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;Phonons.WriteFreqFile: Writing&#39;</span><span class="p">,</span><span class="n">filename</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># index   freq/meV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">  </span><span class="si">%f</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1000</span><span class="o">*</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="WriteVibDOSFile"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.WriteVibDOSFile">[docs]</a><span class="k">def</span> <span class="nf">WriteVibDOSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">):</span>
    <span class="s1">&#39;Vibrational DOS with Gaussian or Lorentzian broadening&#39;</span>
    <span class="n">fmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span>
    <span class="n">erng</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.2</span><span class="o">*</span><span class="n">fmax</span><span class="p">,</span><span class="mi">1001</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">ERNG</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">erng</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">eta</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ETA</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">0</span><span class="o">*</span><span class="n">erng</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">eta</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">erng</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">eta</span><span class="p">)),</span><span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-.</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">ETA</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ERNG</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ETA</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
            <span class="n">spectrum</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-.</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">ETA</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ERNG</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ETA</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="o">==</span><span class="s1">&#39;Lorentzian&#39;</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">ETA</span><span class="o">/</span><span class="p">((</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ERNG</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ETA</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">-=</span> <span class="mi">1</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">ETA</span><span class="o">/</span><span class="p">((</span><span class="o">-</span><span class="n">hw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">ERNG</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ETA</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Write data to file</span>
    <span class="k">print</span> <span class="s1">&#39;Phonons.WriteVibDOSFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># energy/eV  DOS/atom (eta=1,2,3,...,10meV) </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">erng</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5e</span><span class="s1">  &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">erng</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eta</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5e</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                                </div>

<div class="viewcode-block" id="WriteAXSFFiles"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.WriteAXSFFiles">[docs]</a><span class="k">def</span> <span class="nf">WriteAXSFFiles</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">FCfirst</span><span class="p">,</span><span class="n">FClast</span><span class="p">):</span>
    <span class="s1">&#39;Writes the vibrational normal coordinates in xcrysden axsf-format (isolated molecule)&#39;</span>
    <span class="k">print</span> <span class="s1">&#39;Phonons.WriteAXSFFile: Writing&#39;</span><span class="p">,</span><span class="n">filename</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ANIMSTEPS </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATOMS </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">anr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">FClast</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">FCfirst</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="WriteAXSFFilesPer"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.WriteAXSFFilesPer">[docs]</a><span class="k">def</span> <span class="nf">WriteAXSFFilesPer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">vectors</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span><span class="n">anr</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">FCfirst</span><span class="p">,</span><span class="n">FClast</span><span class="p">):</span>
    <span class="s1">&#39;Writes the vibrational normal coordinates in xcrysden axsf-format (periodic structure)&#39;</span>
    <span class="k">print</span> <span class="s1">&#39;Phonons.WriteAXSFFilePer: Writing&#39;</span><span class="p">,</span><span class="n">filename</span>
    <span class="n">VEC</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">),</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)),</span><span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">VEC</span><span class="p">[:,</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="mi">3</span><span class="o">*</span><span class="n">FClast</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ANIMSTEPS </span><span class="si">%i</span><span class="se">\n</span><span class="s1">CRYSTAL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hw</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PRIMVEC </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">vectors</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PRIMCOORD </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">anr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">VEC</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api-gen/Inelastica.Phonons.html#Inelastica.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="n">CF</span><span class="o">.</span><span class="n">CreatePipeOutput</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DestDir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">options</span><span class="o">.</span><span class="n">Logfile</span><span class="p">)</span>
    <span class="n">CF</span><span class="o">.</span><span class="n">PrintMainHeader</span><span class="p">(</span><span class="s1">&#39;Phonons&#39;</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>

    <span class="c1"># Determine SIESTA input fdf files in FCruns</span>
    <span class="n">fdf</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">FCwildcard</span><span class="o">+</span><span class="s1">&#39;/RUN.fdf&#39;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s1">&#39;Phonons.Analyze: This run uses&#39;</span>
    <span class="n">FCfirst</span><span class="p">,</span><span class="n">FClast</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;  ... FCfirst     = </span><span class="si">%4i</span><span class="s1">, FClast     = </span><span class="si">%4i</span><span class="s1">, Dynamic atoms = </span><span class="si">%4i</span><span class="s1">&#39;</span>\
          <span class="o">%</span><span class="p">(</span><span class="n">FCfirst</span><span class="p">,</span><span class="n">FClast</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">))</span>
    <span class="k">print</span> <span class="s1">&#39;  ... DeviceFirst = </span><span class="si">%4i</span><span class="s1">, DeviceLast = </span><span class="si">%4i</span><span class="s1">, Device atoms  = </span><span class="si">%4i</span><span class="s1">&#39;</span>\
          <span class="o">%</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceFirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceLast</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceLast</span><span class="o">-</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceFirst</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;  ... PBC First   = </span><span class="si">%4i</span><span class="s1">, PBC Last   = </span><span class="si">%4i</span><span class="s1">, Device atoms  = </span><span class="si">%4i</span><span class="s1">&#39;</span>\
          <span class="o">%</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PBCFirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">PBCLast</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">PBCLast</span><span class="o">-</span><span class="n">options</span><span class="o">.</span><span class="n">PBCFirst</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Setting array type to </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">options</span><span class="o">.</span><span class="n">atype</span>

    <span class="c1"># Build Dynamical Matrix</span>
    <span class="n">DM</span> <span class="o">=</span> <span class="n">DynamicalMatrix</span><span class="p">(</span><span class="n">fdf</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">DynamicAtoms</span><span class="p">)</span>
    <span class="n">DM</span><span class="o">.</span><span class="n">SetMasses</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">Isotopes</span><span class="p">)</span>
    <span class="c1"># Compute modes</span>
    <span class="n">DM</span><span class="o">.</span><span class="n">ComputePhononModes</span><span class="p">(</span><span class="n">DM</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="c1"># Compute e-ph coupling</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">CalcCoupl</span><span class="p">:</span>
       <span class="n">DM</span><span class="o">.</span><span class="n">PrepareGradients</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">onlySdir</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">kpoint</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceFirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">DeviceLast</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">AbsEref</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">atype</span><span class="p">)</span>
       <span class="n">DM</span><span class="o">.</span><span class="n">ComputeEPHcouplings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PBCFirst</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">PBCLast</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">EPHAtoms</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">Restart</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">CheckPointNetCDF</span><span class="p">,</span>
                              <span class="n">WriteGradients</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">WriteGradients</span><span class="p">)</span>
       <span class="c1"># Write data to files</span>
       <span class="n">DM</span><span class="o">.</span><span class="n">WriteOutput</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DestDir</span><span class="o">+</span><span class="s1">&#39;/Output&#39;</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">SinglePrec</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">GammaPoint</span><span class="p">)</span>
       <span class="n">CF</span><span class="o">.</span><span class="n">PrintMainFooter</span><span class="p">(</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">DM</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span><span class="n">DM</span><span class="o">.</span><span class="n">s0</span><span class="p">,</span><span class="n">DM</span><span class="o">.</span><span class="n">hw</span><span class="p">,</span><span class="n">DM</span><span class="o">.</span><span class="n">heph</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">DM</span><span class="o">.</span><span class="n">WriteOutput</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">DestDir</span><span class="o">+</span><span class="s1">&#39;/Output&#39;</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">SinglePrec</span><span class="p">,</span><span class="n">options</span><span class="o">.</span><span class="n">GammaPoint</span><span class="p">)</span>
       <span class="n">CF</span><span class="o">.</span><span class="n">PrintMainFooter</span><span class="p">(</span><span class="s1">&#39;Phonons&#39;</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">DM</span><span class="o">.</span><span class="n">hw</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2002-2018, Magnus Paulsson and Thomas Frederiksen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.3.0-10',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>