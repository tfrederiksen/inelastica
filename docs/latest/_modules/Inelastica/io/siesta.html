

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Inelastica.io.siesta &mdash; Inelastica v1.3.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Inelastica
          

          
            
            <img src="../../../_static/82px-Inelastica-logo-mini.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.3.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts.html">Scripts</a></li>
</ul>
<p class="caption"><span class="caption-text">Publications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publications.html">Publications using Inelastica</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api-gen/Inelastica.html">Inelastica package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Inelastica</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>Inelastica.io.siesta</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Inelastica.io.siesta</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">:mod:`Inelastica.io.siesta`</span>
<span class="sd">===========================</span>

<span class="sd">Routines for IO in different formats:</span>

<span class="sd">1. Geometries in xyz, XV, ANI, fdf, mkl etc formats</span>
<span class="sd">2. Read Hamiltonian and Overlap from *.TSHS* file</span>
<span class="sd">3. fdf manipulations</span>
<span class="sd">4. Real space Gaussian cube files</span>
<span class="sd">5. Obtain information of basis orbitals for calculation (*.ion.nc*)</span>

<span class="sd">Classes</span>
<span class="sd">-------</span>

<span class="sd">.. autosummary::</span>
<span class="sd">   :toctree:</span>

<span class="sd">   HS</span>

<span class="sd">.. currentmodule:: Inelastica.io.siesta</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">LA</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="kn">as</span> <span class="nn">NC4</span>
<span class="kn">import</span> <span class="nn">Inelastica.physics.constants</span> <span class="kn">as</span> <span class="nn">PC</span>
<span class="kn">import</span> <span class="nn">Inelastica.misc.valuecheck</span> <span class="kn">as</span> <span class="nn">VC</span>

<span class="c1"># For speed some routines can be linked as F90 code</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Inelastica.fortran.F90helpers</span> <span class="kn">as</span> <span class="nn">F90</span>
    <span class="n">F90imported</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">F90imported</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">print</span> <span class="s2">&quot;########################################################&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;Problems encountered with F90helpers.so&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;Falling back on a pure python (slower) implementation&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;Try compiling manually following these steps:&quot;</span>
    <span class="k">print</span> <span class="s2">&quot; $ cd Inelastica/fortran&quot;</span>
    <span class="k">print</span> <span class="s2">&quot; $ source compile.bat (or compile_alternative.bat)&quot;</span>
    <span class="k">print</span> <span class="s2">&quot; $ cp F90helpers.so &lt;python&gt;/site-packages/Inelastica/fortran&quot;</span>
    <span class="k">print</span> <span class="s2">&quot;########################################################&quot;</span>

<span class="c1"># Check length of int and long and use the one that has 8 bytes</span>
<span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
    <span class="n">fortranPrefix</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>
    <span class="n">fortranuLong</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
    <span class="n">fortranLong</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fortranPrefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">fortranuLong</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
    <span class="n">fortranLong</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>


<div class="viewcode-block" id="SIO_open"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.SIO_open">[docs]</a><span class="k">def</span> <span class="nf">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
    <span class="s2">&quot;A io.siesta redefinition of the function open() to handle gzip format&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="c1"># filename is explicitly a gzip file</span>
            <span class="n">gzfile</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># filename is given as a non-zip file</span>
            <span class="n">gzfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># if filename is not existing upon read, then try append the &#39;.gz&#39; ending</span>
        <span class="n">gzfile</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.gz&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gzfile</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># XV-format</span>


<div class="viewcode-block" id="ReadXVFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadXVFile">[docs]</a><span class="k">def</span> <span class="nf">ReadXVFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">InUnits</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">,</span> <span class="n">OutUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">ReadVelocity</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s2">&quot;Returns tuple (vectors,speciesnumber,atomnumber,xyz,[v,]) from an XV-file&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadXVFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Ang2Bohr</span>
    <span class="k">elif</span> <span class="p">(((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">))</span> \
       <span class="ow">or</span> <span class="p">((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">))):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadXVFile: Unit conversion error!&#39;</span>
    <span class="n">xvfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="c1"># Read cell vectors (lines 1-3)</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xvfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">convFactor</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="c1"># Read number of atoms (line 4)</span>
    <span class="n">numberOfAtoms</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xvfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Read remaining lines</span>
    <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xvfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Ignore blank lines</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">speciesnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">atomnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">convFactor</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
            <span class="n">V</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">convFactor</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">xvfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numberOfAtoms</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadXVFile: Inconstency in </span><span class="si">%s</span><span class="s1"> detected!&#39;</span> <span class="o">%</span><span class="n">filename</span>
    <span class="k">if</span> <span class="n">ReadVelocity</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></div>


<div class="viewcode-block" id="WriteXVFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteXVFile">[docs]</a><span class="k">def</span> <span class="nf">WriteXVFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span>\
                <span class="n">InUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">OutUnits</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">,</span> <span class="n">Velocity</span><span class="o">=</span><span class="p">[]):</span>
    <span class="s2">&quot;Writes (vectors,speciesnumber,atomnumber,xyz,[V],) to the XV-file format&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteXVFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Ang2Bohr</span>
    <span class="k">elif</span> <span class="p">(((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">))</span> \
       <span class="ow">or</span> <span class="p">((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">))):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteXVFile: Unit conversion error!&#39;</span>
    <span class="n">xvfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># Write basis vectors (lines 1-3)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">convFactor</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;     0.00  0.00  0.00 </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">xvfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c1"># Write number of atoms (line 4)</span>
    <span class="n">numberOfAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">)</span>
    <span class="n">xvfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;     </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">numberOfAtoms</span><span class="p">)</span>
    <span class="c1"># Go through the remaining lines</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfAtoms</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;  </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;  </span><span class="si">%i</span><span class="s1">  &#39;</span> <span class="o">%</span><span class="n">atomnumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">convFactor</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Velocity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;     0.00  0.00  0.00 &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Velocity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">convFactor</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">xvfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">xvfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReadAXVFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadAXVFile">[docs]</a><span class="k">def</span> <span class="nf">ReadAXVFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">MDstep</span><span class="p">,</span> <span class="n">tmpXVfile</span><span class="o">=</span><span class="s2">&quot;tmp.XV&quot;</span><span class="p">,</span> <span class="n">ReadVelocity</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s2">&quot;Read concatenated XV files from an MD simulation&quot;</span>
    <span class="c1"># Determine the number of atoms in the supercell</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">Natoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">XVlines</span> <span class="o">=</span> <span class="n">Natoms</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="c1"># Extract the XV file from MDstep and write tmpXVfile</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpXVfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MDstep</span><span class="o">*</span><span class="n">XVlines</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MDstep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">XVlines</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">MDstep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">XVlines</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># Read tmpXVfile corresponding to MDstep</span>
    <span class="k">return</span> <span class="n">ReadXVFile</span><span class="p">(</span><span class="n">tmpXVfile</span><span class="p">,</span> <span class="n">InUnits</span><span class="o">=</span><span class="s1">&#39;Bohr&#39;</span><span class="p">,</span> <span class="n">OutUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">ReadVelocity</span><span class="o">=</span><span class="n">ReadVelocity</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># AXSF-format</span>
<div class="viewcode-block" id="WriteAXSFFiles"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteAXSFFiles">[docs]</a><span class="k">def</span> <span class="nf">WriteAXSFFiles</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">forces</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s1">&#39;Writes [geom1, geom2 ...] to AXSF format&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ANIMSTEPS </span><span class="si">%i</span><span class="se">\n</span><span class="s1">CRYSTAL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PRIMVEC </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PRIMCOORD </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> 1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span><span class="p">)):</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">forces</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ln</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># ANI-format</span>

<div class="viewcode-block" id="WriteANIFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteANIFile">[docs]</a><span class="k">def</span> <span class="nf">WriteANIFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">Geom</span><span class="p">,</span> <span class="n">Energy</span><span class="p">,</span> <span class="n">InUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">OutUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">):</span>
    <span class="s2">&quot; Write .ANI file from list of geometries with Energy=[E1,E2..]&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteANIFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Ang2Bohr</span>
    <span class="k">elif</span> <span class="p">(((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">))</span> \
          <span class="ow">or</span> <span class="p">((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">))):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteANIFile: Unit conversion error!&#39;</span>
    <span class="n">anifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">iGeom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Geom</span><span class="p">):</span>
        <span class="n">anifile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">iGeom</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">anifile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">Energy</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">iixyz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iGeom</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="n">anifile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%2.6f</span><span class="s1"> </span><span class="si">%2.6f</span><span class="s1"> </span><span class="si">%2.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span>\
                          <span class="p">(</span><span class="n">PC</span><span class="o">.</span><span class="n">PeriodicTable</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">iGeom</span><span class="o">.</span><span class="n">anr</span><span class="p">[</span><span class="n">iixyz</span><span class="p">])],</span>\
                           <span class="n">convFactor</span><span class="o">*</span><span class="n">iGeom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iixyz</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>\
                           <span class="n">convFactor</span><span class="o">*</span><span class="n">iGeom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iixyz</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>\
                           <span class="n">convFactor</span><span class="o">*</span><span class="n">iGeom</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iixyz</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
    <span class="n">anifile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReadANIFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadANIFile">[docs]</a><span class="k">def</span> <span class="nf">ReadANIFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">InUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">,</span> <span class="n">OutUnits</span><span class="o">=</span><span class="s1">&#39;Ang&#39;</span><span class="p">):</span>
    <span class="s2">&quot;Returns tuple (Geometry,Energy[Ry?],) from an ANI-file&quot;</span>
    <span class="kn">import</span> <span class="nn">Inelastica.MakeGeom</span> <span class="kn">as</span> <span class="nn">MG</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadANIFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Ang2Bohr</span>
    <span class="k">elif</span> <span class="p">(((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span><span class="p">))</span> \
          <span class="ow">or</span> <span class="p">((</span><span class="n">InUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">OutUnits</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">))):</span> <span class="n">convFactor</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadANIFile: Unit conversion error!&#39;</span>

    <span class="n">Energy</span><span class="p">,</span> <span class="n">Geom</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">anifile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">newNN</span> <span class="o">=</span> <span class="n">anifile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">newNN</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">newNN</span><span class="p">)</span>
        <span class="n">newG</span> <span class="o">=</span> <span class="n">MG</span><span class="o">.</span><span class="n">Geom</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">anifile</span><span class="o">.</span><span class="n">readline</span><span class="p">()))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">Energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NN</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">anifile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="p">[</span><span class="n">convFactor</span><span class="o">*</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                   <span class="n">convFactor</span><span class="o">*</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>\
                   <span class="n">convFactor</span><span class="o">*</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span>
            <span class="n">newG</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PC</span><span class="o">.</span><span class="n">PeriodicTable</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">Geom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newG</span><span class="p">)</span>
        <span class="n">newNN</span> <span class="o">=</span> <span class="n">anifile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">anifile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Geom</span><span class="p">,</span> <span class="n">Energy</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Reading SIESTA FC ascii files</span>


<div class="viewcode-block" id="ReadFCFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadFCFile">[docs]</a><span class="k">def</span> <span class="nf">ReadFCFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Returns FC from an FC-file&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFCFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">fcfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="c1"># Read comment line (line 1)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">fcfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Force constants matrix&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFCFile: Inconstency in </span><span class="si">%s</span><span class="s1"> detected!&#39;</span> <span class="o">%</span><span class="n">filename</span>
    <span class="c1"># Read remaining lines</span>
    <span class="n">FC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fcfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">FC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">fcfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">FC</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Reading SIESTA Fortan binary files</span>


<div class="viewcode-block" id="ReadFortranBin"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadFortranBin">[docs]</a><span class="k">def</span> <span class="nf">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">printLength</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="s2">&quot;Reads Fortran binary data structures&quot;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="n">fmt</span> <span class="o">+=</span> <span class="n">dtype</span>
    <span class="n">fbin</span> <span class="o">=</span> <span class="n">fortfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fortranPrefix</span><span class="o">+</span><span class="n">fortranuLong</span><span class="o">+</span><span class="n">fmt</span><span class="o">+</span><span class="n">fortranuLong</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">unpack</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fortranPrefix</span><span class="o">+</span><span class="n">fortranLong</span><span class="o">+</span><span class="n">fmt</span><span class="o">+</span><span class="n">fortranLong</span><span class="p">,</span> <span class="n">fbin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">printLength</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFortranBin: </span><span class="si">%i</span><span class="s1"> bytes read&#39;</span> <span class="o">%</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fortranPrefix</span><span class="o">+</span><span class="n">fmt</span><span class="p">):</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFortranBin: Error reading Fortran formatted binary file&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fbin</span></div>


<div class="viewcode-block" id="ReadWFSFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadWFSFile">[docs]</a><span class="k">def</span> <span class="nf">ReadWFSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TF/071008</span>
<span class="sd">    Returns the WF coefficients etc. from SIESTA systemlabe.WFS files</span>
<span class="sd">    (see siesta/utils/readwf.f for details)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fortfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">nk</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nspin</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nuotot</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print nk, nspin, nuotot</span>

    <span class="n">PSIvectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iik</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iispin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspin</span><span class="p">):</span>
            <span class="n">ik</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">k3</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;Iddd&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1">#print ik,k1,k2,k3</span>
            <span class="n">ispin</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nwflist</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1">#print ispin,nwflist</span>
            <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwflist</span><span class="p">):</span>
                <span class="n">REpsi</span><span class="p">,</span> <span class="n">IMpsi</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="n">indwf</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">energy</span><span class="p">,</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1">#print indwf, energy</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuotot</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span> <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39;c&#39;</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;III&#39;</span><span class="o">+</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">lab1</span><span class="p">,</span> <span class="n">lab2</span><span class="p">,</span> <span class="n">repsi</span><span class="p">,</span> <span class="n">impsi</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">21</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">44</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span>
                    <span class="n">labelfis</span><span class="p">,</span> <span class="n">symfio</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
                        <span class="n">labelfis</span> <span class="o">+=</span> <span class="n">lab1</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="n">symfio</span> <span class="o">+=</span> <span class="n">lab2</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="c1">#print labelfis,symfio</span>
                    <span class="n">REpsi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repsi</span><span class="p">),</span> <span class="n">IMpsi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">impsi</span><span class="p">)</span>
                <span class="n">PSIvectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">REpsi</span><span class="p">)</span><span class="o">+</span><span class="mi">1j</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IMpsi</span><span class="p">))</span>
    <span class="n">fortfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nk</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">nwflist</span><span class="p">,</span> <span class="n">PSIvectors</span></div>


<div class="viewcode-block" id="printDone"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.printDone">[docs]</a><span class="k">def</span> <span class="nf">printDone</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">mess</span><span class="p">):</span>
    <span class="c1"># Print progress report</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">mess</span><span class="p">,</span> <span class="s2">&quot;: </span><span class="si">%3.0f</span><span class="s2"> </span><span class="si">%%</span><span class="s2"> done&quot;</span> <span class="o">%</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="mf">10.0</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">mess</span><span class="p">,</span> <span class="s2">&quot;: 100 </span><span class="si">% d</span><span class="s2">one&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># MKL-format IO</span>


<div class="viewcode-block" id="WriteMKLFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteMKLFile">[docs]</a><span class="k">def</span> <span class="nf">WriteMKLFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">FCfirst</span><span class="p">,</span> <span class="n">FClast</span><span class="p">):</span>
    <span class="s2">&quot;Writes a MKL-file&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteMKLFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">mklfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;$MKL</span><span class="se">\n</span><span class="s1">$COORD</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;$END</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;$FREQ</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C1 C1 C1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Write frequencies</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">freq</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="c1"># Write in meV</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="n">f</span><span class="o">.</span><span class="n">real</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="n">f</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1"># Write modes</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FCfirst</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;0 0 0 0 0 0 0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FClast</span><span class="o">-</span><span class="n">FCfirst</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">vec</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FClast</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
                <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;0 0 0 0 0 0 0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">mklfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;$END</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mklfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># XYZ-format IO</span>


<div class="viewcode-block" id="ReadXYZFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadXYZFile">[docs]</a><span class="k">def</span> <span class="nf">ReadXYZFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">xyzfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="c1"># Read number of atoms (line 4)</span>
    <span class="n">numberOfAtoms</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Read remaining lines</span>
    <span class="n">label</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xyzfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Ignore blank lines</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">atomnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PC</span><span class="o">.</span><span class="n">PeriodicTable</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">xyzfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numberOfAtoms</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadXYZFile: Inconstency in </span><span class="si">%s</span><span class="s1"> detected!&#39;</span> <span class="o">%</span><span class="n">filename</span>
    <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span></div>


<div class="viewcode-block" id="WriteXYZFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteXYZFile">[docs]</a><span class="k">def</span> <span class="nf">WriteXYZFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">write_ghosts</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s2">&quot;Writes atomic geometry in xyz-file format&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteXYZFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="c1"># Number of ghost atoms</span>
    <span class="n">nga</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Write file</span>
    <span class="n">xyzfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_ghosts</span><span class="p">:</span>
        <span class="n">xyzfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nga</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;... skipped </span><span class="si">%i</span><span class="s1"> ghost atoms&#39;</span><span class="o">%</span><span class="n">nga</span>
        <span class="n">xyzfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">-</span><span class="n">nga</span><span class="p">))</span>
    <span class="n">xyzfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">PeriodicTable</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">atomnumber</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">atomnumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">write_ghosts</span><span class="p">:</span>
            <span class="n">xyzfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">xyzfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># FDF format IO</span>


<div class="viewcode-block" id="ReadFDFFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadFDFFile">[docs]</a><span class="k">def</span> <span class="nf">ReadFDFFile</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Reads an FDF file and gives the output values: pbc, xyz, snr, anr, natoms</span>
<span class="sd">        infile = FDF inputfile&quot;&quot;&quot;</span>
    <span class="n">pbc</span> <span class="o">=</span> <span class="n">Getpbc</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">Getxyz</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">pbc</span><span class="p">)</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">Getsnr</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">anr</span> <span class="o">=</span> <span class="n">Getanr</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="n">Getnatoms</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">natoms</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;Error! natoms != len(xyz)&#39;</span>
    <span class="k">return</span> <span class="n">pbc</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="n">anr</span><span class="p">,</span> <span class="n">natoms</span></div>


<div class="viewcode-block" id="WriteFDFFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteFDFFile">[docs]</a><span class="k">def</span> <span class="nf">WriteFDFFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">):</span>
    <span class="s2">&quot;Write STRUCT.fdf file&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteFDFFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">fdffile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NumberOfAtoms &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NumberOfSpecies &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;LatticeConstant 1.0 Ang</span><span class="se">\n</span><span class="s1">%block LatticeVectors</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">vectors</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock LatticeVectors</span><span class="se">\n</span><span class="s1">AtomicCoordinatesFormat  Ang&#39;</span><span class="o">+</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">%block AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39; # </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock AtomicCoordinatesAndAtomicSpecies</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WriteFDFFileZmat"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteFDFFileZmat">[docs]</a><span class="k">def</span> <span class="nf">WriteFDFFileZmat</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmat</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write STRUCT.fdf file using the z-matrix format</span>
<span class="sd">       xyz        : all cartesian coordinates</span>
<span class="sd">       first/last : first,last atoms in molecule block</span>
<span class="sd">       zmat[:,:3] : integer part of z-matrix (indices)</span>
<span class="sd">       zmat[:,3:] : fractional part of z-matrix (angles)&quot;&quot;&quot;</span>
    <span class="c1"># Sanity check</span>
    <span class="k">if</span> <span class="n">first</span> <span class="o">&gt;</span> <span class="n">last</span> <span class="ow">or</span> <span class="n">first</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">last</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="ow">or</span> <span class="n">last</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteFDFFileZmat: Meaningless first (</span><span class="si">%i</span><span class="s1">) / last (</span><span class="si">%i</span><span class="s1">) inputs. &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
        <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># Writing zmatrix</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteFDFFileZmat: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">zmatfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NumberOfAtoms &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NumberOfSpecies &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;LatticeConstant 1.0 Ang</span><span class="se">\n</span><span class="s1">%block LatticeVectors</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">vectors</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock LatticeVectors</span><span class="se">\n</span><span class="s1">AtomicCoordinatesFormat Ang&#39;</span><span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">ZM.UnitsLength Ang</span><span class="se">\n</span><span class="s1">ZM.UnitsAngle deg</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span>
                   <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">%block Zmatrix</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cartesian</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;molecule</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">:</span>
            <span class="c1"># We are within the molecular block</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">zmat</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">first</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> </span><span class="si">%i</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">e</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">f</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;   0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">string</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;   0 0 0</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cartesian</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;constants</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;variables</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;constraints</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">zmatfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock Zmatrix</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Read systemlabel.STRUCT_OUT files</span>


<div class="viewcode-block" id="ReadSTRUCT_OUTFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadSTRUCT_OUTFile">[docs]</a><span class="k">def</span> <span class="nf">ReadSTRUCT_OUTFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">stfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="c1"># Read cell vectors (lines 1-3)</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">stfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="c1"># Read number of atoms (line 4)</span>
    <span class="n">numberOfAtoms</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">stfile</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Read remaining lines</span>
    <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># Ignore blank lines</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">speciesnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">atomnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">stfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">speciesnumber</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numberOfAtoms</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadSTRUCT_OUTFile: Inconstency in </span><span class="si">%s</span><span class="s1"> detected!&#39;</span> <span class="o">%</span><span class="n">filename</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>
        <span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vectors</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Writing SIESTA Fortran binary files</span>


<div class="viewcode-block" id="WriteFortranBin"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteFortranBin">[docs]</a><span class="k">def</span> <span class="nf">WriteFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="s2">&quot;Writes Fortran binary data structures&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span> <span class="n">L</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span> <span class="n">fmt</span> <span class="o">+=</span> <span class="n">dtype</span>
    <span class="n">fbin</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fortranPrefix</span><span class="o">+</span><span class="n">fortranLong</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
            <span class="n">fbin</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fbin</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">fbin</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fortranuLong</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>
    <span class="n">fortfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fbin</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># &quot;Low-level&quot; FDF format functionality</span>

<div class="viewcode-block" id="ReadFDFLines"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadFDFLines">[docs]</a><span class="k">def</span> <span class="nf">ReadFDFLines</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">printAlot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns an FDF file and all the %include files as split strings</span>
<span class="sd">        infile = input file&quot;&quot;&quot;</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">infile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">printAlot</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFDFLines: Reading&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="n">fdffile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">fdffile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># Remove &#39;:&#39; from fdf</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1"># Remove &#39;=&#39; from fdf</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>  <span class="c1"># Remove comments</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">nclude&#39;</span><span class="p">:</span>
                    <span class="n">subfile</span> <span class="o">=</span> <span class="n">head</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">ReadFDFLines</span><span class="p">(</span><span class="n">subfile</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="n">head</span><span class="p">,</span> <span class="n">printAlot</span><span class="o">=</span><span class="n">printAlot</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">tmp2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">fdffile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">fdffile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="Getnatoms"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.Getnatoms">[docs]</a><span class="k">def</span> <span class="nf">Getnatoms</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gives the number of atoms included in an FDF file</span>
<span class="sd">        infile = FDF input file&quot;&quot;&quot;</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;NumberOfAtoms&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">natoms</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;NumberOfAtoms:&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">natoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Getxyz"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.Getxyz">[docs]</a><span class="k">def</span> <span class="nf">Getxyz</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">pbc</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Gives a list of the xyz posistions in a FDF file</span>
<span class="sd">        infile = FDF input file&quot;&quot;&quot;</span>
    <span class="n">latt_const</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;LatticeConstant&#39;</span><span class="p">)</span>
    <span class="n">AC_format</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;AtomicCoordinatesFormat&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">latt_const</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">:</span>
        <span class="n">latt_const</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latt_const</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latt_const</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latt_const</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;AtomicCoordinatesAndAtomicSpecies&#39;</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ang&#39;</span> <span class="ow">or</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NotScaledCartesianAng&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span> <span class="ow">or</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NotScaledCartesianBohr&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ScaledCartesian&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">latt_const</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">elif</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Fractional&#39;</span> <span class="ow">or</span> <span class="n">AC_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ScaledByLatticeVectors&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Give correct AtomicCoordinates Format&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz</span></div>


<div class="viewcode-block" id="Getpbc"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.Getpbc">[docs]</a><span class="k">def</span> <span class="nf">Getpbc</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gives a list of the lattice vectores in a FDF file</span>
<span class="sd">        infile = FDF input file&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;LatticeVectors&#39;</span><span class="p">)</span>
    <span class="n">pbc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">latt_const</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;LatticeConstant&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">latt_const</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bohr&#39;</span><span class="p">:</span>
        <span class="n">latt_const</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latt_const</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latt_const</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latt_const</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">pbc</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">latt_const</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">pbc</span></div>


<div class="viewcode-block" id="Getsnr"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.Getsnr">[docs]</a><span class="k">def</span> <span class="nf">Getsnr</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gives a list of the species numbers in a FDF file</span>
<span class="sd">        infile = FDF input file&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;AtomicCoordinatesAndAtomicSpecies&#39;</span><span class="p">)</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">snr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">snr</span></div>


<div class="viewcode-block" id="Getanr"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.Getanr">[docs]</a><span class="k">def</span> <span class="nf">Getanr</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gives a list of the atomic numbers in a FDF file</span>
<span class="sd">        infile = FDF input file&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;ChemicalSpeciesLabel&#39;</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
        <span class="n">table</span><span class="p">[</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">Getsnr</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">anr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snr</span><span class="p">)):</span>
        <span class="n">anr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">snr</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">anr</span></div>


<div class="viewcode-block" id="GetFDFline"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetFDFline">[docs]</a><span class="k">def</span> <span class="nf">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">KeyWord</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">printAlot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Finds a line and gives the value as a string</span>
<span class="sd">        infile = FDF input file</span>
<span class="sd">        KeyWord = line to find&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">ReadFDFLines</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">printAlot</span><span class="o">=</span><span class="n">printAlot</span><span class="p">)</span>
    <span class="n">kwl</span> <span class="o">=</span> <span class="n">KeyWord</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">]:</span> <span class="c1"># these characters should be ignored in fdf keys</span>
        <span class="n">kwl</span> <span class="o">=</span> <span class="n">kwl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">]:</span> <span class="c1"># these characters should be ignored in fdf keys</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">kwl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span></div>


<div class="viewcode-block" id="GetFDFlineWithDefault"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetFDFlineWithDefault">[docs]</a><span class="k">def</span> <span class="nf">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Finds a line and gives the value of type type.</span>
<span class="sd">        If not found, default returned.</span>
<span class="sd">        If default=None, print error and exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFline</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">printAlot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;GetFDFlineWithDefault failed to find &quot;{}&quot; in file {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Boolean is tricky!</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;.true.&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;.false.&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;GetFDFlineWithDefault failed to convert &#39;</span><span class="o">+</span>
                                <span class="s1">&#39;&quot;{}&quot; to boolean from key &quot;{}&quot; in file {}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">))</span></div>


<div class="viewcode-block" id="GetFDFblock"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetFDFblock">[docs]</a><span class="k">def</span> <span class="nf">GetFDFblock</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">KeyWord</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the values in a block as strings</span>
<span class="sd">       infile = FDF input file</span>
<span class="sd">       KeyWord = block to find&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">ReadFDFLines</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">kwl</span> <span class="o">=</span> <span class="n">KeyWord</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;%block&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">]:</span> <span class="c1"># these characters should be ignored in fdf keys</span>
                <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">kwl</span> <span class="o">=</span> <span class="n">kwl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">kwl</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Only append data if block was found</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">start</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">data</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="GetTotalEnergy"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetTotalEnergy">[docs]</a><span class="k">def</span> <span class="nf">GetTotalEnergy</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="c1"># Find total energy from SIESTA stdout file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">E</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Total&#39;</span> <span class="ow">in</span> <span class="n">words</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">E</span></div>


<div class="viewcode-block" id="GetFermiEnergy"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetFermiEnergy">[docs]</a><span class="k">def</span> <span class="nf">GetFermiEnergy</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="c1"># Read Fermi energy from SIESTA stdout file</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.GetFermiEnergy: Reading&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">E</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Fermi&#39;</span> <span class="ow">in</span> <span class="n">words</span> <span class="ow">and</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">print</span> <span class="s1">&#39;... eF = </span><span class="si">%.4f</span><span class="s1"> eV&#39;</span><span class="o">%</span><span class="n">E</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">E</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;... did not find the Fermi energy&#39;</span>
    <span class="k">return</span> <span class="n">E</span></div>


<div class="viewcode-block" id="ReadEIGfile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadEIGfile">[docs]</a><span class="k">def</span> <span class="nf">ReadEIGfile</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">printing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">FermiRef</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c1"># Read *EIG file and print eigenvalues with respect to eF.</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">eF</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c1"># Skip second line</span>
    <span class="n">EIG</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">eig</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># Skip first entry in third line</span>
    <span class="n">EIG</span> <span class="o">+=</span> <span class="n">eig</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">eig</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">EIG</span> <span class="o">+=</span> <span class="n">eig</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">FermiRef</span><span class="p">:</span>
        <span class="c1"># Do not take Fermi level as energy reference</span>
        <span class="n">eF</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">printing</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;# State, eigenvalue wrt. eF&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">EIG</span><span class="p">)):</span>
            <span class="k">print</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">EIG</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">eF</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">eF</span></div>


<div class="viewcode-block" id="ReadMullikenPop"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadMullikenPop">[docs]</a><span class="k">def</span> <span class="nf">ReadMullikenPop</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">writeallblocks</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># Read Mulliken populations from the *.out file</span>
    <span class="n">mline</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">mpop</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">popsum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">itera</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">block</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">spin</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadMullikenPop: Reading&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="n">exc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;mulliken: Atomic and Orbital Populations:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># Start of populations block</span>
            <span class="n">mline</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">itera</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;mulliken: Spin&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">spin</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="s1">&#39;mulliken: Qtot =&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># Determine whether or not we are still within a populations block</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="ow">and</span> <span class="n">block</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">mline</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">mline</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">mpop</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c1"># Write data to file</span>
            <span class="k">if</span> <span class="n">writeallblocks</span><span class="p">:</span>
                <span class="n">thisfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%.2i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">itera</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">thisfile</span> <span class="o">=</span> <span class="n">outfile</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="ow">and</span> <span class="n">block</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">thisfile</span> <span class="o">+=</span> <span class="s1">&#39;.UP&#39;</span>
            <span class="k">if</span> <span class="n">spin</span> <span class="ow">and</span> <span class="n">block</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">thisfile</span> <span class="o">+=</span> <span class="s1">&#39;.DOWN&#39;</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">thisfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Sum of Mulliken charges: </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">popsum</span><span class="p">)</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Atomnr  Pop.  dPop   Cum.sum.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mpop</span><span class="p">)):</span>
                <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  %.i  </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">mpop</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">block</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">mpop</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">popsum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">mline</span><span class="p">:</span>
            <span class="c1"># We are inside a range of lines with mpop</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nr</span><span class="p">,</span> <span class="n">pop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dpop</span> <span class="o">=</span> <span class="n">pop</span><span class="o">-</span><span class="nb">round</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">popsum</span> <span class="o">+=</span> <span class="n">pop</span>
                <span class="n">mpop</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nr</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">dpop</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">popsum</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">spin</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadMullikenPop: Wrote&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.UP&#39;</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadMullikenPop: Wrote&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.DOWN&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadMullikenPop: Wrote&#39;</span><span class="p">,</span> <span class="n">outfile</span>
    <span class="k">if</span> <span class="n">exc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;Warning: </span><span class="si">%i</span><span class="s1"> exceptions encountered in ReadMullikenPop&#39;</span><span class="o">%</span><span class="n">exc</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReadForces"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadForces">[docs]</a><span class="k">def</span> <span class="nf">ReadForces</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="c1"># Read forces from the *.out file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fline</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadForces: Reading&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">fline</span><span class="p">:</span>
            <span class="c1"># We are inside a range of lines with forces</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">])])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fline</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s1">&#39;Atomic forces&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># Start of forces block</span>
            <span class="n">fline</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ReadFAFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadFAFile">[docs]</a><span class="k">def</span> <span class="nf">ReadFAFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="s2">&quot;Returns forces from a FA-file&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadFAFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="c1"># Read comment line (line 1)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="c1"># Read remaining lines</span>
    <span class="n">FA</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">FA</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FA</span><span class="p">)</span></div>


<div class="viewcode-block" id="ReadTRANSAVfile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadTRANSAVfile">[docs]</a><span class="k">def</span> <span class="nf">ReadTRANSAVfile</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="c1"># Read (averaged *.TRANS.AV) transmission function</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e10</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">[</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Related to band structure calculations and density of states</span>


<div class="viewcode-block" id="CrossProd"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.CrossProd">[docs]</a><span class="k">def</span> <span class="nf">CrossProd</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
    <span class="s2">&quot;Returns the cross product of two geometric vectors&quot;</span>
    <span class="p">[</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">az</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
    <span class="p">[</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ay</span><span class="o">*</span><span class="n">bz</span><span class="o">-</span><span class="n">az</span><span class="o">*</span><span class="n">by</span><span class="p">,</span> <span class="n">az</span><span class="o">*</span><span class="n">bx</span><span class="o">-</span><span class="n">ax</span><span class="o">*</span><span class="n">bz</span><span class="p">,</span> <span class="n">ax</span><span class="o">*</span><span class="n">by</span><span class="o">-</span><span class="n">ay</span><span class="o">*</span><span class="n">bx</span><span class="p">])</span></div>


<div class="viewcode-block" id="GetReciprocalLatticeVectors"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetReciprocalLatticeVectors">[docs]</a><span class="k">def</span> <span class="nf">GetReciprocalLatticeVectors</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="c1"># Calculate reciprocal lattice vectors</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.GetReciprocalLatticeVectors: Reading&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="k">if</span> <span class="n">infile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fdf&#39;</span><span class="p">):</span>
        <span class="n">pbc</span> <span class="o">=</span> <span class="n">Getpbc</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">infile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.XV&#39;</span><span class="p">):</span>
        <span class="n">pbc</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">ReadXVFile</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pbc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pbc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pbc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">CrossProd</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">CrossProd</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)))</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">CrossProd</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">CrossProd</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a0</span><span class="p">)))</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">CrossProd</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">CrossProd</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span></div>


<div class="viewcode-block" id="WriteBandLinesFDF"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteBandLinesFDF">[docs]</a><span class="k">def</span> <span class="nf">WriteBandLinesFDF</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="c1"># Sets up an fdf-file which can be included in RUN.fdf for</span>
    <span class="c1"># calculating band structure and total density of states</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteBandLinesFDF: Writing fdf-input file&#39;</span><span class="p">,</span> <span class="n">outfile</span>
    <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">GetReciprocalLatticeVectors</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;BandLineScale  pi/a</span><span class="se">\n</span><span class="s1">%block BandLines</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;1   0.00  0.00  0.00  \Gamma</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="o">/</span><span class="n">res</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39;  </span><span class="si">%.8f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">  b0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">b0</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="o">/</span><span class="n">res</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39;  </span><span class="si">%.8f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">  </span><span class="si">%.8f</span><span class="s1">  b1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">((</span><span class="n">b0</span><span class="o">+</span><span class="n">b1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b0</span><span class="o">+</span><span class="n">b1</span><span class="p">,</span> <span class="n">b0</span><span class="o">+</span><span class="n">b1</span><span class="p">)</span><span class="o">**.</span><span class="mi">5</span><span class="o">/</span><span class="n">res</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39;  0.00  0.00  0.00  \Gamma</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#n = int(N.dot(b2,b2)**.5/res)</span>
    <span class="c1">#f.write(&#39;%i&#39;%n+&#39;  %.8f  %.8f  %.8f  b2\n&#39;%tuple(b2/(2*N.pi)))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock BandLines</span><span class="se">\n</span><span class="s1">WriteBands true</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock BandLines</span><span class="se">\n</span><span class="s1">WriteBands true</span><span class="se">\n</span><span class="s1">PDOSBandbyBand true</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;%block ProjectedDensityOfStates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-10.0 5.0 0.10 500 eV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">ndblock ProjectedDensityOfStates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReadBlock"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadBlock">[docs]</a><span class="k">def</span> <span class="nf">ReadBlock</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">):</span>
    <span class="c1"># Designed for reading, e.g., *.bands files from SIESTA</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ReadBandsFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadBandsFile">[docs]</a><span class="k">def</span> <span class="nf">ReadBandsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">origformat</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadBandsFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="c1"># Reads SIESTA *.bands files</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="c1"># line 1:</span>
    <span class="n">eF</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># lines 2-3:</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># lines 4:</span>
    <span class="nb">eval</span><span class="p">,</span> <span class="n">spins</span><span class="p">,</span> <span class="n">kpts</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origformat</span><span class="p">:</span>
        <span class="n">linesPerKpt</span> <span class="o">=</span> <span class="p">(</span><span class="n">spins</span><span class="o">*</span><span class="nb">eval</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="c1"># SIESTA</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">spins</span><span class="o">*</span><span class="nb">eval</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">linesPerKpt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linesPerKpt</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Siesta-2.5?</span>
    <span class="c1"># Read k-points</span>
    <span class="n">EvsK</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kpts</span><span class="p">):</span>
        <span class="n">EvsK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">linesPerKpt</span><span class="p">))</span>
    <span class="c1"># Read labels</span>
    <span class="n">numlabels</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numlabels</span><span class="p">):</span>
        <span class="n">lab</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ReadBlock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">lab</span><span class="p">),</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">eF</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">EvsK</span><span class="p">),</span> <span class="n">labels</span><span class="p">,</span> <span class="n">spins</span></div>


<div class="viewcode-block" id="WriteBandsFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.WriteBandsFile">[docs]</a><span class="k">def</span> <span class="nf">WriteBandsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">eF</span><span class="p">,</span> <span class="n">EvsK</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">spins</span><span class="p">):</span>
    <span class="s2">&quot;Writes SIESTA *.bands files&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.WriteBandsFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span> <span class="o">&lt;</span> <span class="n">ymin</span><span class="p">:</span> <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">:])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%.9f</span><span class="s1">       </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">eF</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%.9f</span><span class="s1">  </span><span class="si">%.9f</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%.9f</span><span class="s1">  </span><span class="si">%.9f</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%i</span><span class="s1">    </span><span class="si">%i</span><span class="s1">    </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">spins</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">            &#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%i</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="ConvertBandsFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ConvertBandsFile">[docs]</a><span class="k">def</span> <span class="nf">ConvertBandsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">eF</span><span class="p">,</span> <span class="n">EvsK</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">spins</span> <span class="o">=</span> <span class="n">ReadBandsFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ConvertBandsFile: Writing&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.dat&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">EvsK</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">   </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">EvsK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReadDOSFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadDOSFile">[docs]</a><span class="k">def</span> <span class="nf">ReadDOSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Reads SIESTA *.DOS files</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadDOSFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">DOS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">DOS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOS</span><span class="p">)</span></div>


<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># XML-format</span>

<span class="kn">import</span> <span class="nn">xml.dom.minidom</span> <span class="kn">as</span> <span class="nn">xml</span>


<div class="viewcode-block" id="GetXMLFermiEnergy"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetXMLFermiEnergy">[docs]</a><span class="k">def</span> <span class="nf">GetXMLFermiEnergy</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="s2">&quot;Looks for the Fermi energy in xml file&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;E_Fermi&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
        <span class="n">eF</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.GetXMLFermiEnergy: Found E_Fermi = </span><span class="si">%.8f</span><span class="s1"> eV&#39;</span><span class="o">%</span><span class="n">eF</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">eF</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">eF</span></div>


<div class="viewcode-block" id="GetPDOSnspin"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPDOSnspin">[docs]</a><span class="k">def</span> <span class="nf">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="s2">&quot;Returns an integer for the number of spins (variable nspin)&quot;</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;nspin&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPDOSnorbitals"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPDOSnorbitals">[docs]</a><span class="k">def</span> <span class="nf">GetPDOSnorbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="c1"># Read norbitals</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;norbitals&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPDOSenergyValues"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPDOSenergyValues">[docs]</a><span class="k">def</span> <span class="nf">GetPDOSenergyValues</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="c1"># Read energy values</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;energy_values&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPDOSfromOrbitals"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPDOSfromOrbitals">[docs]</a><span class="k">def</span> <span class="nf">GetPDOSfromOrbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[],</span> <span class="n">mlist</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GetPDOSenergyValues</span><span class="p">(</span><span class="n">dom</span><span class="p">))</span><span class="o">*</span><span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">pdos</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;orbital&#39;</span><span class="p">)</span>
    <span class="n">usedOrbitals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;atom_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ai</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_index</span> <span class="ow">and</span> <span class="n">atom_index</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species</span> <span class="ow">and</span> <span class="n">species</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nlist</span> <span class="ow">and</span> <span class="n">nlist</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">llist</span> <span class="ow">and</span> <span class="n">llist</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mlist</span> <span class="ow">and</span> <span class="n">mlist</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">usedOrbitals</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">ai</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">pdos</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Generate some output-related information</span>
    <span class="k">if</span> <span class="n">atom_index</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">print</span> <span class="s1">&#39;... Atom indices =&#39;</span><span class="p">,</span> <span class="n">atom_index</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">print</span> <span class="s1">&#39;... Species =&#39;</span><span class="p">,</span> <span class="n">species</span>
    <span class="k">if</span> <span class="n">nlist</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">print</span> <span class="s1">&#39;... Allowed n quantum numbers =&#39;</span><span class="p">,</span> <span class="n">nlist</span>
    <span class="k">if</span> <span class="n">llist</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">print</span> <span class="s1">&#39;... Allowed l quantum numbers =&#39;</span><span class="p">,</span> <span class="n">llist</span>
    <span class="k">if</span> <span class="n">mlist</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="k">print</span> <span class="s1">&#39;... Allowed m quantum numbers =&#39;</span><span class="p">,</span> <span class="n">mlist</span>
    <span class="k">print</span> <span class="s1">&#39;... Orbitals included =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedOrbitals</span><span class="p">)</span>
    <span class="n">usedAtoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">orb</span> <span class="ow">in</span> <span class="n">usedOrbitals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">orb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">usedAtoms</span><span class="p">:</span> <span class="n">usedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">print</span> <span class="s1">&#39;... Atoms included =&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedAtoms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pdos</span><span class="p">,</span> <span class="n">usedOrbitals</span><span class="p">,</span> <span class="n">usedAtoms</span></div>


<div class="viewcode-block" id="ReadPDOSFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadPDOSFile">[docs]</a><span class="k">def</span> <span class="nf">ReadPDOSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[],</span> <span class="n">mlist</span><span class="o">=</span><span class="p">[]):</span>
    <span class="c1"># Reads SIESTA *.PDOS files summing up contributions from orbitals</span>
    <span class="c1"># belonging to a subset specified by the keywords</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">nspin</span> <span class="o">=</span> <span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">norb</span> <span class="o">=</span> <span class="n">GetPDOSnorbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="n">GetPDOSenergyValues</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">eF</span> <span class="o">=</span> <span class="n">GetXMLFermiEnergy</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">pdos</span><span class="p">,</span> <span class="n">usedOrbitals</span><span class="p">,</span> <span class="n">usedAtoms</span> <span class="o">=</span> <span class="n">GetPDOSfromOrbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">atom_index</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">llist</span><span class="p">,</span> <span class="n">mlist</span><span class="p">)</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">pdos</span><span class="p">,</span> <span class="n">usedOrbitals</span><span class="p">,</span> <span class="n">usedAtoms</span><span class="p">,</span> <span class="n">eF</span></div>


<div class="viewcode-block" id="ExtractPDOS"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ExtractPDOS">[docs]</a><span class="k">def</span> <span class="nf">ExtractPDOS</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[],</span> <span class="n">mlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">FermiRef</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">Normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ExtractPDOS: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">pdos</span><span class="p">,</span> <span class="n">usedOrbitals</span><span class="p">,</span> <span class="n">usedAtoms</span><span class="p">,</span> <span class="n">eF</span> <span class="o">=</span> <span class="n">ReadPDOSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">atom_index</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">llist</span><span class="p">,</span> <span class="n">mlist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">FermiRef</span><span class="p">:</span>
        <span class="c1"># Set energy reference to the Fermi energy</span>
        <span class="k">if</span> <span class="n">eF</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">eF</span> <span class="o">=</span> <span class="n">GetFermiEnergy</span><span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="s1">&#39;/RUN.out&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eF</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.ExtractPDOS: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.EIG&#39;</span>
            <span class="n">eF</span> <span class="o">=</span> <span class="n">ReadEIGfile</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.EIG&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;... eF = </span><span class="si">%.4f</span><span class="s1"> eV&#39;</span><span class="o">%</span><span class="n">eF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set energy reference to SIESTAs internal</span>
        <span class="n">eF</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">Normalize</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedAtoms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pdos</span> <span class="o">=</span> <span class="n">pdos</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">usedAtoms</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ExtractPDOS: Normalizing PDOS to states/atom/eV&#39;</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span> <span class="c1"># Write to file or return lists</span>
        <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># No spin</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.ExtractPDOS: Writing&#39;</span><span class="p">,</span> <span class="n">outfile</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.9f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span><span class="p">,</span> <span class="n">pdos</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Spin polarized</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.ExtractPDOS: Writing&#39;</span><span class="p">,</span> <span class="n">outfile</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.9f</span><span class="s1"> </span><span class="si">%.9f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span><span class="p">,</span> <span class="n">pdos</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">pdos</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ev</span><span class="o">-</span><span class="n">eF</span><span class="p">,</span> <span class="p">[</span><span class="n">pdos</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">pdos</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ev</span><span class="o">-</span><span class="n">eF</span><span class="p">,</span> <span class="p">[</span><span class="n">pdos</span><span class="p">]</span></div>

<span class="c1"># Functions specific to syslabel.PROJBANDS files</span>
<span class="c1"># (k-resolved PDOS is available from a modified SIESTA by D. Sanchez-Portal)</span>


<div class="viewcode-block" id="GetPROJBANDSnbands"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPROJBANDSnbands">[docs]</a><span class="k">def</span> <span class="nf">GetPROJBANDSnbands</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the (integer) number of bands &quot;&quot;&quot;</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;nbands&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPROJBANDSkpoint"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPROJBANDSkpoint">[docs]</a><span class="k">def</span> <span class="nf">GetPROJBANDSkpoint</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="s2">&quot;Returns an array with the (3D) k-points&quot;</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;kpoint&#39;</span><span class="p">)</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">kpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPROJBANDSenergies"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPROJBANDSenergies">[docs]</a><span class="k">def</span> <span class="nf">GetPROJBANDSenergies</span><span class="p">(</span><span class="n">dom</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an array with the band energies (in units of eV):</span>
<span class="sd">        energies = energies[ k-index, band-index, n-spin ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nspin</span> <span class="o">=</span> <span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="n">GetPROJBANDSnbands</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;energies&#39;</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">nspin</span><span class="p">))</span>
        <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># NB: This conversion is weird and linked to the initial output of the modified SIESTA!!!</span>
    <span class="k">return</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span></div>


<div class="viewcode-block" id="GetPROJBANDSfromOrbitals"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetPROJBANDSfromOrbitals">[docs]</a><span class="k">def</span> <span class="nf">GetPROJBANDSfromOrbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an array of the DOS projected onto bands, summing up contributions from</span>
<span class="sd">    orbitals as specified in the function call. The indexing is the following:</span>
<span class="sd">       pdos = pdos[ k-index, band-index, spin-index ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nspin</span> <span class="o">=</span> <span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="n">GetPROJBANDSnbands</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">pdos</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">GetPROJBANDSenergies</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;orbital&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Next k-point</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;atom_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">index</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ai</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_index</span> <span class="ow">and</span> <span class="n">atom_index</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species</span> <span class="ow">and</span> <span class="n">species</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nlist</span> <span class="ow">and</span> <span class="n">nlist</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">llist</span> <span class="ow">and</span> <span class="n">llist</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Adding PDOS from (k=</span><span class="si">%i</span><span class="s1">,i=</span><span class="si">%i</span><span class="s1">,ai=</span><span class="si">%i</span><span class="s1">,s=</span><span class="si">%s</span><span class="s1">,n=</span><span class="si">%i</span><span class="s1">,l=</span><span class="si">%i</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ai</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;bandproj&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># First (and only) entry</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">nspin</span><span class="p">))</span>
            <span class="n">pdos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pdos</span></div>


<div class="viewcode-block" id="ReadPROJBANDSfile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadPROJBANDSfile">[docs]</a><span class="k">def</span> <span class="nf">ReadPROJBANDSfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">nspin</span> <span class="o">=</span> <span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="n">GetPROJBANDSnbands</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">norb</span> <span class="o">=</span> <span class="n">GetPDOSnorbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">GetPROJBANDSenergies</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">kresPDOS</span> <span class="o">=</span> <span class="n">GetPROJBANDSfromOrbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">atom_index</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">llist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nbands</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">kresPDOS</span></div>


<div class="viewcode-block" id="ExtractPROJBANDS"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ExtractPROJBANDS">[docs]</a><span class="k">def</span> <span class="nf">ExtractPROJBANDS</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[],</span> <span class="n">atom_index</span><span class="o">=</span><span class="p">[],</span> <span class="n">species</span><span class="o">=</span><span class="p">[],</span> <span class="n">nlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">llist</span><span class="o">=</span><span class="p">[],</span> <span class="n">emin</span><span class="o">=-</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="n">eF</span> <span class="o">=</span> <span class="n">GetFermiEnergy</span><span class="p">(</span><span class="s1">&#39;RUN.out&#39;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">nspin</span> <span class="o">=</span> <span class="n">GetPDOSnspin</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="n">GetPROJBANDSnbands</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">norb</span> <span class="o">=</span> <span class="n">GetPDOSnorbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">GetPROJBANDSkpoint</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">GetPROJBANDSenergies</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">kresPDOS</span> <span class="o">=</span> <span class="n">GetPROJBANDSfromOrbitals</span><span class="p">(</span><span class="n">dom</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">atom_index</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">nlist</span><span class="p">,</span> <span class="n">llist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nspin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># No spin</span>
        <span class="n">points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.dx.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span> <span class="o">&gt;=</span> <span class="n">emin</span> <span class="ow">and</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span> <span class="o">&lt;=</span> <span class="n">emax</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%.9f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eF</span><span class="p">,</span> <span class="n">kresPDOS</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">points</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Not yet implemented for spin polarized data.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Write DX datafile</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;.dx.general&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;file = </span><span class="si">%s</span><span class="s1">.dx.dat</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">outfile</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;points = </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">points</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;format = ascii</span><span class="se">\n</span><span class="s1">interleaving = field</span><span class="se">\n</span><span class="s1">field = locations, field0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;structure = 2-vector, scalar</span><span class="se">\n</span><span class="s1">type = float, float</span><span class="se">\n\n</span><span class="s1">end</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># label.ion.nc - files</span>

<div class="viewcode-block" id="ReadIonNCFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadIonNCFile">[docs]</a><span class="k">def</span> <span class="nf">ReadIonNCFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">printnorm</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a NetCDF file that describes the basis orbitals of a given species</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">ion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nb">file</span> <span class="o">=</span> <span class="n">NC4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;Reading Basis from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>

    <span class="c1"># General attributes</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">Element</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">Label</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">atomnum</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">Atomic_number</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">numorb</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">Number_of_orbitals</span>

    <span class="c1"># Variables</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;orbnl_l&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;orbnl_n&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">Z</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;orbnl_z&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">ispol</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;orbnl_ispol&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">orb</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;orb&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">][:],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">print</span> <span class="s1">&#39;   Element: </span><span class="si">%s</span><span class="s1">   Atom number: </span><span class="si">%i</span><span class="s1">,  L-orbs &#39;</span><span class="o">%</span> <span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">atomnum</span><span class="p">),</span> <span class="n">ion</span><span class="o">.</span><span class="n">L</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">)):</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">**</span><span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span><span class="o">**</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">rr</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
        <span class="c1"># check normalization:</span>
        <span class="k">if</span> <span class="n">printnorm</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;   orb </span><span class="si">%i</span><span class="s1"> (L=</span><span class="si">%i</span><span class="s1">),    Norm = </span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">rr</span><span class="o">*</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span> <span class="n">ion</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span><span class="p">)</span>
    <span class="n">ion</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span><span class="o">*</span><span class="n">ion</span><span class="o">.</span><span class="n">delta</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ion</span></div>


<div class="viewcode-block" id="BuildBasis"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.BuildBasis">[docs]</a><span class="k">def</span> <span class="nf">BuildBasis</span><span class="p">(</span><span class="n">FDFfile</span><span class="p">,</span> <span class="n">FirstAtom</span><span class="p">,</span> <span class="n">LastAtom</span><span class="p">,</span> <span class="n">lasto</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds the information for each basis orbital in the Hamiltonian</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">basis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">CSL</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">FDFfile</span><span class="p">,</span> <span class="s1">&#39;ChemicalSpeciesLabel&#39;</span><span class="p">)</span>
    <span class="n">systemlabel</span> <span class="o">=</span> <span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">FDFfile</span><span class="p">,</span> <span class="s1">&#39;SystemLabel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;siesta&#39;</span><span class="p">,</span> <span class="s1">&#39;io.siesta&#39;</span><span class="p">)</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">FDFfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">XVfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.XV&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">systemlabel</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># XV file prevails</span>
        <span class="n">vectors</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">ReadXVFile</span><span class="p">(</span><span class="n">XVfile</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">vectors</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">speciesnumber</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">natoms</span> <span class="o">=</span> <span class="n">ReadFDFFile</span><span class="p">(</span><span class="n">FDFfile</span><span class="p">)</span>
    <span class="n">ions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CSL</span><span class="p">)):</span>
        <span class="c1"># Read ion-nc file for each SIESTA species</span>
        <span class="n">ions</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">CSL</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ReadIonNCFile</span><span class="p">(</span><span class="n">head</span><span class="o">+</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">.ion.nc&#39;</span><span class="o">%</span><span class="n">CSL</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Determine the basis dimension nn</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FirstAtom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LastAtom</span><span class="p">):</span> <span class="c1"># Python counts from zero</span>
        <span class="n">nn</span> <span class="o">+=</span> <span class="n">ions</span><span class="p">[</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">numorb</span>

    <span class="k">if</span> <span class="n">nn</span> <span class="o">!=</span> <span class="n">lasto</span><span class="p">[</span><span class="n">LastAtom</span><span class="p">]</span><span class="o">-</span><span class="n">lasto</span><span class="p">[</span><span class="n">FirstAtom</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">print</span> <span class="s2">&quot;Length of basis set build: </span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">nn</span>
        <span class="k">print</span> <span class="s2">&quot;Size of Hamiltonian: </span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">lasto</span><span class="p">[</span><span class="n">LastAtom</span><span class="p">]</span><span class="o">-</span><span class="n">lasto</span><span class="p">[</span><span class="n">FirstAtom</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Error: Could not build basis set. Check if all ion.nc files are there!&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Initiate basis variables</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">ii</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">atomnum</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">orb</span><span class="p">,</span> <span class="n">basis</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">basis</span><span class="o">.</span><span class="n">coff</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nn</span><span class="p">,),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="c1"># Describe each basis orbital</span>
    <span class="n">iorb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">FirstAtom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">LastAtom</span><span class="p">):</span>
        <span class="n">an</span> <span class="o">=</span> <span class="n">atomnumber</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ion</span> <span class="o">=</span> <span class="n">ions</span><span class="p">[</span><span class="n">speciesnumber</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">jj</span><span class="p">],</span> <span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">ii</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">atomnum</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">an</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">L</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">kk</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iorb</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ion</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">orb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">coff</span><span class="p">[</span><span class="n">iorb</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">orb</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="p">:])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ion</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">basis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ion</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">iorb</span> <span class="o">=</span> <span class="n">iorb</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">print</span> <span class="s1">&#39;io.siesta.BuildBasis: Generated basis&#39;</span>
    <span class="k">print</span> <span class="s1">&#39;... First atom      = </span><span class="si">%i</span><span class="s1"> (Siesta numbering)&#39;</span><span class="o">%</span><span class="n">FirstAtom</span>
    <span class="k">print</span> <span class="s1">&#39;... Last atom       = </span><span class="si">%i</span><span class="s1"> (Siesta numbering)&#39;</span><span class="o">%</span><span class="n">LastAtom</span>
    <span class="k">print</span> <span class="s1">&#39;... Basis dimension = </span><span class="si">%i</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">basis</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Gaussian Cube files</span>


<div class="viewcode-block" id="ReadCubeFile"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadCubeFile">[docs]</a><span class="k">def</span> <span class="nf">ReadCubeFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadCubeFile: Reading geometry from&#39;</span><span class="p">,</span> <span class="n">filename</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="c1"># Read comments (lines 1-2)</span>
    <span class="n">comm1</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">comm2</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="c1"># Read number of atoms and coordinate origin (line 3)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
    <span class="n">numberOfAtoms</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="c1"># Read cell vectors (lines 4-6)</span>
    <span class="n">vox</span><span class="p">,</span> <span class="n">vectors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">vox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>

    <span class="c1"># Read geometry (lines 7-7+N)</span>
    <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfAtoms</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">atomnumber</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">string</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>

    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">atomnumber</span><span class="p">,</span> <span class="n">xyz</span></div>


<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># Consistency checks of SIESTA output files (RUN.out)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>


<div class="viewcode-block" id="GetSiestaStarttime"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetSiestaStarttime">[docs]</a><span class="k">def</span> <span class="nf">GetSiestaStarttime</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;head &#39;</span><span class="o">+</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;&gt;&gt;&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt; Start of run:  </span><span class="si">%d</span><span class="s1">-%b-%Y  %H:%M:%S     &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">starttime</span></div>


<div class="viewcode-block" id="GetSiestaEndtime"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetSiestaEndtime">[docs]</a><span class="k">def</span> <span class="nf">GetSiestaEndtime</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen3</span><span class="p">(</span><span class="s1">&#39;tail &#39;</span><span class="o">+</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;&gt;&gt;&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt; End of run:  </span><span class="si">%d</span><span class="s1">-%b-%Y  %H:%M:%S     &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">endtime</span></div>


<div class="viewcode-block" id="GetSiestaWalltime"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetSiestaWalltime">[docs]</a><span class="k">def</span> <span class="nf">GetSiestaWalltime</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="s2">&quot;Returns the walltime (in hours)&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">GetSiestaEndtime</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span><span class="o">-</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">GetSiestaStarttime</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">seconds</span><span class="o">/</span><span class="mi">60</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.GetSiestaWalltime: Walltime could not be extracted from&#39;</span><span class="p">,</span> <span class="n">infile</span>
    <span class="k">return</span> <span class="n">hours</span></div>


<div class="viewcode-block" id="CheckTermination"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.CheckTermination">[docs]</a><span class="k">def</span> <span class="nf">CheckTermination</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">GetSiestaEndtime</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<span class="c1">#--------------------------------------------------------------------------------</span>
<span class="c1"># New TSHS file format used for FCrun, TSrun and onlyS</span>

<span class="c1">#</span>
<span class="c1">#  UNITS! Always eV and Angstrom!</span>
<span class="c1">#         k-values always given in range [0,1.0] (or [-0.5,0.5])</span>
<span class="c1">#         They are not in reciprocal space. Instead they corresponds</span>
<span class="c1">#         to the mathematical orthogonal space that is fourier</span>
<span class="c1">#         transformed.</span>
<span class="c1">#</span>


<div class="viewcode-block" id="HS"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS">[docs]</a><span class="k">class</span> <span class="nc">HS</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create full *HS* from *TSHS* file. Read fn and assemble for specified k-point</span>

<span class="sd">    External variables:</span>

<span class="sd">    - *N*                        : Size of matrices</span>
<span class="sd">    - *H[ispin,i,j]*             : Hamiltonian</span>
<span class="sd">    - *S[i,j]*                   : Overlap</span>

<span class="sd">    Internal variables from TS (**NOTE**: index described as fortran</span>
<span class="sd">    definition -- all python lists start with index 0!):</span>

<span class="sd">    - *nua*                      : Number of atoms in unitcell</span>
<span class="sd">    - *nuo*                      : Number of orbitals in unitcell</span>
<span class="sd">    - *nspin*                    : Number of spin</span>
<span class="sd">    - *no*                       : Number of orbitals in supercell</span>
<span class="sd">    - *maxnh*                    : Size of sparse matrices</span>
<span class="sd">    - *isa(1:nua)*               : Atomic number (not in netcdf)</span>
<span class="sd">    - *lasto(0:nua)*             : Last orbital of atom in unitcell</span>
<span class="sd">    - *xa(1:nua,1:3)*            : Position of atoms (NOTE transpose of TS standard)</span>
<span class="sd">    - *indxuo(1:no)*             : Index of equivalent orbital in unitcell</span>
<span class="sd">    - *numh(1:nuo)*              : Number of non-zero elements in row of H</span>
<span class="sd">    - *listh(1:nuo)*             : Column index of H element</span>
<span class="sd">    - *Hsparse(1:nspin,1:maxnh)* : Sparse H</span>
<span class="sd">    - *Ssparse(1:nspin,1:maxnh)* : Sparse S</span>
<span class="sd">    - *qtot*                     : ??</span>
<span class="sd">    - *temp*                     : ??</span>
<span class="sd">    - *ef*                       : Fermi energy (why spin dependent?)</span>
<span class="sd">    - *cell(1:3,1:3)*            : Unitcell (ixyz,ivec)</span>
<span class="sd">    - *gamma*                    : Logical Gamma-point</span>
<span class="sd">    - *xij(1:maxnh,1:3)*         : Vector between orbital centers</span>
<span class="sd">       * (**NOTE1:** transpose of TS)</span>
<span class="sd">       * (**NOTE2:** xij=Rj-Ri where i,j correspond to Hij)</span>

<span class="sd">    Derived internal variables:</span>

<span class="sd">    - *listhptr(1:nuo)*          : Start of row-1 in sparse matrix</span>
<span class="sd">    - *atomindx(1:nuo)*          : Atom index corresponding to orbital in unitcell</span>
<span class="sd">    - *rcell(1:3,1:3)*           : Reciprocal lattice vectors (ivec,ixyz) (rcell . cell = I)</span>

<span class="sd">    For onlyS: Hsparse is not avalable and gamma point is assumed</span>

<span class="sd">    For gamma: xij is set to 0 and indxuo set manually to 1:nou and -1 for nou+1:no to catch errors!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">BufferAtoms</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,)),</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">if</span> <span class="n">UseF90helpers</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;io.siesta.HS.__init__: F90helpers do not support reading of gzipped TSHS-files. Please unzip and try again.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">UseF90helpers</span> <span class="ow">and</span> <span class="n">F90imported</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta.HS.__init__: Reading&#39;</span><span class="p">,</span> <span class="n">fn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxnh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qtot</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_kscell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_kdispl</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">ts_gamma_scf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ia1</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">readtshs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="c1"># Logical</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="n">na</span> <span class="o">=</span> <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">na</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Remove any buffer-atoms</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxnh</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">readtshs</span><span class="o">.</span><span class="n">remove_atoms</span><span class="p">(</span><span class="n">BufferAtoms</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span> <span class="o">*</span> <span class="n">ns</span>

            <span class="c1"># Arrays</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">readtshs</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasto</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">lasto</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xa</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">xa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numh</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">numh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listh</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">listh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">listhptr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xij</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">xij</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ssparse</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Hsparse</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">F90</span><span class="o">.</span><span class="n">readtshs</span><span class="o">.</span><span class="n">deallocate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Buffer atoms are not allowed when reading binary files from python&quot;</span><span class="p">)</span>
            <span class="n">general</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="n">matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ReadTSHSFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxnh</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ia1</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">qtot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ef</span> <span class="o">=</span> <span class="n">general</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lasto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indxuo</span> <span class="o">=</span> <span class="n">sparse</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ssparse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hsparse</span> <span class="o">=</span> <span class="n">matrices</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ssparse</span> <span class="o">=</span> <span class="n">matrices</span>
        <span class="c1"># Adjust memory layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xa</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xij</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Hsparse</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hsparse</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>
        <span class="k">print</span> <span class="s2">&quot;Found </span><span class="si">%i</span><span class="s2"> atoms, (</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">) orbitals in super-, unit-cell&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makeDerivedQuant</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">removeUnitCellXij</span><span class="p">(</span><span class="n">UseF90helpers</span><span class="p">)</span> <span class="c1"># Remove phase change in unitcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetkpoint</span><span class="p">()</span> <span class="c1"># save time by not repeating</span>

<div class="viewcode-block" id="HS.resetkpoint"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS.resetkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">resetkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the kpoint and H,S.</span>
<span class="sd">        The garbage collector cannot tell if H or S will be used subsequently</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;H&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
        <span class="k">if</span> <span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span></div>

    <span class="k">def</span> <span class="nf">__ReadTSHSFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Python version for reading TSHS files.</span>
<span class="sd">        For return see code:</span>
<span class="sd">        Note that onlyS -&gt; does not return xij or Hsparse</span>
<span class="sd">                  gamma -&gt; sets indxuo by hand to 1:nou, -1 for nou+1:nos! and sets xij=0.0</span>
<span class="sd">        xa[atomnr,xyz] : Atom positions</span>
<span class="sd">        ucell[nr,xyz]  : Unitcell</span>
<span class="sd">        xij[nr,xyz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.__ReadTSHSFile: Reading&#39;</span><span class="p">,</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Open binary Fortran file</span>
        <span class="n">fortfile</span> <span class="o">=</span> <span class="n">SIO_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">nau</span><span class="p">,</span> <span class="n">nou</span><span class="p">,</span> <span class="n">nos</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">maxnh</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nau</span><span class="p">)),</span> <span class="p">(</span><span class="n">nau</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">xa</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>
        <span class="n">isa</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="n">nau</span><span class="p">);</span> <span class="k">del</span> <span class="n">isa</span>
        <span class="n">ucell</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>        <span class="c1"># Read boolean (works with ifort)</span>
        <span class="n">onlyS</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>        <span class="c1"># Read boolean (works with ifort)</span>
        <span class="n">ts_gamma_scf</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="c1"># Read boolean (works with ifort)</span>
        <span class="n">ts_kscell</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="mi">9</span><span class="p">)),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ts_kdispl</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">istep</span><span class="p">,</span> <span class="n">ia1</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">lasto</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="n">nau</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gamma</span><span class="p">:</span>
            <span class="n">indxuo</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="n">nos</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For gamma point make indxuo such that indexes not pointing to unitcell give error, i.e., -1.</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nou</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nos</span><span class="o">-</span><span class="n">nou</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="n">indxuo</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">))</span>
        <span class="n">numhg</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="n">nou</span><span class="p">))</span>
        <span class="n">qtot</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span>
        <span class="n">ef</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span>
        <span class="n">listh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nou</span><span class="p">):</span>
            <span class="n">listh</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="n">fortranLong</span><span class="p">,</span> <span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
        <span class="n">listh</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">listh</span><span class="p">)</span>
        <span class="n">Ssparse</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">maxnh</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nou</span><span class="p">):</span>
            <span class="n">Ssparse</span><span class="p">[</span><span class="n">cnt</span><span class="p">:</span><span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyS</span><span class="p">:</span>
            <span class="n">Hsparse</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nspin</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ispin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspin</span><span class="p">):</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nou</span><span class="p">):</span>
                    <span class="n">Hsparse</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="n">cnt</span><span class="p">:</span><span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">Hsparse</span> <span class="o">=</span> <span class="n">Hsparse</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Rydberg2eV</span>
            <span class="n">Hsparse</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">Hsparse</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gamma</span><span class="p">:</span>
            <span class="c1"># Read xij</span>
            <span class="n">xij</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maxnh</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nou</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">ReadFortranBin</span><span class="p">(</span><span class="n">fortfile</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span>
                <span class="n">xij</span><span class="p">[</span><span class="n">cnt</span><span class="p">:</span><span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">T</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">+</span><span class="n">numhg</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">xij</span> <span class="o">=</span> <span class="n">xij</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">PC</span><span class="o">.</span><span class="n">Bohr2Ang</span>
            <span class="n">xij</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">xij</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">xij</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">),</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">fortfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">general</span> <span class="o">=</span> <span class="p">[</span><span class="n">nau</span><span class="p">,</span> <span class="n">nou</span><span class="p">,</span> <span class="n">nos</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">onlyS</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">ia1</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ef</span><span class="p">]</span>
        <span class="n">sparse</span> <span class="o">=</span> <span class="p">[</span><span class="n">lasto</span><span class="p">,</span> <span class="n">numhg</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">onlyS</span><span class="p">:</span>
            <span class="n">matrices</span> <span class="o">=</span> <span class="p">[</span><span class="n">xa</span><span class="p">,</span> <span class="n">ucell</span><span class="p">,</span> <span class="n">xij</span><span class="p">,</span> <span class="n">Ssparse</span><span class="p">,</span> <span class="n">Hsparse</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matrices</span> <span class="o">=</span> <span class="p">[</span><span class="n">xa</span><span class="p">,</span> <span class="n">ucell</span><span class="p">,</span> <span class="n">xij</span><span class="p">,</span> <span class="n">Ssparse</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">general</span><span class="p">,</span> <span class="n">sparse</span><span class="p">,</span> <span class="n">matrices</span>

<div class="viewcode-block" id="HS.makeDerivedQuant"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS.makeDerivedQuant">[docs]</a>    <span class="k">def</span> <span class="nf">makeDerivedQuant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create derived internal variables:</span>
<span class="sd">        listhptr(1:nuo) : Start of row-1 in sparse matrix</span>
<span class="sd">        atomindx(1:nuo) : Atom index corresponding to orbital in unitcell</span>
<span class="sd">        rcell(1:3,1:3)  : Reciprocal lattice vectors (ivec,ixyz) (rcell . cell = I)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># numh(1:nuo)  : Number of non-zero elements in row of H</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;listhptr&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># lasto(0:nua) : Last orbital of atom in unitcell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomindx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">io</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">io</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasto</span><span class="p">[</span><span class="n">atom</span><span class="p">]:</span>
                <span class="n">atom</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atomindx</span><span class="p">[</span><span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span>

        <span class="c1"># Reciprocal cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rcell</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span></div>

<div class="viewcode-block" id="HS.removeUnitCellXij"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS.removeUnitCellXij">[docs]</a>    <span class="k">def</span> <span class="nf">removeUnitCellXij</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove displacements within unitcell from xij</span>
<span class="sd">        NOTE: We remove the in cell difference so xij corresponds to</span>
<span class="sd">              lattice vectors to the relevant part of the supercell.</span>
<span class="sd">        NOTE: xij = Rj-Ri where Ri,j corresponds to positions of the orbitals H_{i,j}</span>
<span class="sd">        TODO: Check why some orbitals in sparse matrix reported within cell but have xij!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">F90imported</span> <span class="ow">and</span> <span class="n">UseF90helpers</span><span class="p">:</span>
            <span class="c1">#      subroutine f90removeunitcellxij( maxnh, no, nuo, nua,</span>
            <span class="c1"># +     numh, xij, xa, listhptr, listh, atomindx, xijo)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xij</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">removeunitcellxij</span><span class="p">(</span><span class="n">nnzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnh</span><span class="p">,</span> <span class="n">no_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span>
                                             <span class="n">na_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nua</span><span class="p">,</span>
                                             <span class="n">numh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">,</span>
                                             <span class="n">xij</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">,</span>
                                             <span class="n">xa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">,</span>
                                             <span class="n">listh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">,</span>
                                             <span class="n">atomindx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">atomindx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iuo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jnz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">[</span><span class="n">iuo</span><span class="p">]):</span>
                    <span class="n">jo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">+</span><span class="n">jnz</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">juo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indxuo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">+</span><span class="n">jnz</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">ia</span><span class="p">,</span> <span class="n">ja</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomindx</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomindx</span><span class="p">[</span><span class="n">juo</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="c1">#if juo==jo and N.max(abs(self.xij[self.listhptr[iuo]+jnz,:]))&gt;0.1:</span>
                    <span class="c1">#    print self.xij[self.listhptr[iuo]+jnz,:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">+</span><span class="n">jnz</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">+</span><span class="n">jnz</span><span class="p">]</span><span class="o">-</span>\
                                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">[:,</span> <span class="n">ja</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xa</span><span class="p">[:,</span> <span class="n">ia</span><span class="p">])</span></div>
                    <span class="c1">#if juo==jo and N.max(abs(self.xij[self.listhptr[iuo]+jnz,:]))&gt;0.1:</span>
                    <span class="c1">#    print self.xij[self.listhptr[iuo]+jnz,:]</span>
                    <span class="c1">#if juo!=jo and N.max(abs(self.xij[self.listhptr[iuo]+jnz,:]))&lt;0.1:</span>
                    <span class="c1">#    print self.xij[self.listhptr[iuo]+jnz,:]</span>

<div class="viewcode-block" id="HS.setkpoint"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS.setkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">setkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s2">&quot;Make full matrices from sparse for specific k-point&quot;</span>
        <span class="n">kpoint</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">:</span>
            <span class="n">VC</span><span class="o">.</span><span class="n">Check</span><span class="p">(</span><span class="s2">&quot;same-kpoint&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">kpoint</span><span class="p">),</span>
                     <span class="s2">&quot;Trying to set non-zero k-point for Gamma point calculation.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span><span class="o">-</span><span class="n">kpoint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VC</span><span class="o">.</span><span class="n">GetCheck</span><span class="p">(</span><span class="s2">&quot;same-kpoint&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span> <span class="s2">&quot;io.siesta.HS.setkpoint: </span><span class="si">%s</span><span class="s2"> k =&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">kpoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kpoint</span> <span class="o">=</span> <span class="n">kpoint</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setkpointhelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ssparse</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="n">atype</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">),</span> <span class="n">atype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ispin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspin</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">[</span><span class="n">ispin</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setkpointhelper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Hsparse</span><span class="p">[:,</span> <span class="n">ispin</span><span class="p">],</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="n">atype</span><span class="p">)</span> \
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ef</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span></div>

<div class="viewcode-block" id="HS.setkpointhelper"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.HS.setkpointhelper">[docs]</a>    <span class="k">def</span> <span class="nf">setkpointhelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sparse</span><span class="p">,</span> <span class="n">kpoint</span><span class="p">,</span> <span class="n">UseF90helpers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">complex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make full matrices from sparse for specific k-point</span>
<span class="sd">        NOTE: Assumption for Fourier transform</span>
<span class="sd">        Psi(i) =           sum_R exp(i k.R) Psi_k(i)               NOTE sign!</span>
<span class="sd">        (Full waveunction)                   (Unit cell part of wavefunction)</span>
<span class="sd">              which gives:</span>
<span class="sd">        i,j part of unitcell gives from the rows of the full H:</span>
<span class="sd">            H_k(i,j) = H_(i,j) + sum_R H(i,j+R) exp(i*k*R)         NOTE sign!</span>
<span class="sd">            where R corresponds to R_j-R_0 which is Xij            NOTE sign!</span>

<span class="sd">        For efficiency this routine is normally run in Fortran90. Compile with f2py:</span>
<span class="sd">        cd F90;source compile.bat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">UseF90helpers</span> <span class="ow">and</span> <span class="n">F90imported</span><span class="p">:</span>
            <span class="n">Full</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">setkpointhelper</span><span class="p">(</span><span class="n">nnzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnh</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="n">Sparse</span><span class="p">,</span> <span class="n">kpoint</span><span class="o">=</span><span class="n">kpoint</span><span class="p">,</span>
                                       <span class="n">no_u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="n">numh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">,</span>
                                       <span class="n">rcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rcell</span><span class="p">,</span> <span class="n">xij</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">,</span>
                                       <span class="n">listhptr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">,</span>
                                       <span class="n">listh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">)</span>
            <span class="c1"># Ensure correct memory alignment</span>
            <span class="n">Full</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">Full</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
            <span class="n">Full</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Full</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">),</span> <span class="n">atype</span><span class="p">)</span>
            <span class="c1"># Phase factor</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kpoint</span><span class="p">,</span> <span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rcell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xij</span><span class="p">))</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.0j</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span>    <span class="c1"># exp(2 pi i k*(Rj-Ri)) where i,j from Hij</span>

            <span class="k">for</span> <span class="n">iuo</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nuo</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numh</span><span class="p">[</span><span class="n">iuo</span><span class="p">]):</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listhptr</span><span class="p">[</span><span class="n">iuo</span><span class="p">]</span><span class="o">+</span><span class="n">jz</span>
                    <span class="n">juo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indxuo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">listh</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                <span class="c1">#if juo==self.listh[si]-1:</span>
                <span class="c1">#    if phase[si]!=1.0+0.0j:</span>
                <span class="c1">#        print &quot;hej&quot;</span>
                    <span class="n">Full</span><span class="p">[</span><span class="n">iuo</span><span class="p">,</span> <span class="n">juo</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Sparse</span><span class="p">[</span><span class="n">si</span><span class="p">]</span><span class="o">*</span><span class="n">phase</span><span class="p">[</span><span class="n">si</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Full</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">atype</span><span class="p">):</span>
            <span class="k">print</span> <span class="s1">&#39;io.siesta: Forcing array from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Full</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">atype</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">atype</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">atype</span> <span class="o">==</span> <span class="n">N</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Full</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Full</span><span class="p">,</span> <span class="n">atype</span><span class="p">)</span></div></div>

<span class="c1"># Easy method to read in number of atoms in a TSHS file</span>


<div class="viewcode-block" id="ReadTSHS"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.ReadTSHS">[docs]</a><span class="k">def</span> <span class="nf">ReadTSHS</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">&#39;io.siesta.ReadTSHS: Reading TSHS header from&#39;</span><span class="p">,</span> <span class="n">fn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> not found&#39;</span><span class="o">%</span><span class="n">fn</span><span class="p">)</span>
    <span class="c1"># return dictionary</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Read in TSHS header (do not read in everything!)</span>
    <span class="n">nou</span><span class="p">,</span> <span class="n">nos</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">maxnh</span> <span class="o">=</span> <span class="n">F90</span><span class="o">.</span><span class="n">readtshs</span><span class="o">.</span><span class="n">read_size</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;nua&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nua&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nua</span>
    <span class="k">if</span> <span class="s1">&#39;nuo&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nuo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nuo</span>
    <span class="k">if</span> <span class="s1">&#39;nso&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nso&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nos</span>
    <span class="k">if</span> <span class="s1">&#39;nspin&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nspin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nspin</span>
    <span class="k">if</span> <span class="s1">&#39;maxnh&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;maxnh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxnh</span>
    <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="GetBufferAtomsList"><a class="viewcode-back" href="../../../api-gen/Inelastica.io.siesta.html#Inelastica.io.siesta.GetBufferAtomsList">[docs]</a><span class="k">def</span> <span class="nf">GetBufferAtomsList</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">fdf</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ReadTSHS</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">nua</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">nua</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nua&#39;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">d</span>
    <span class="n">bufL</span> <span class="o">=</span> <span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">fdf</span><span class="p">,</span> <span class="s1">&#39;TS.BufferAtomsLeft&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GetBuffer&#39;</span><span class="p">)</span>
    <span class="n">bufR</span> <span class="o">=</span> <span class="n">GetFDFlineWithDefault</span><span class="p">(</span><span class="n">fdf</span><span class="p">,</span> <span class="s1">&#39;TS.BufferAtomsRight&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;GetBuffer&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">GetFDFblock</span><span class="p">(</span><span class="n">fdf</span><span class="p">,</span> <span class="s1">&#39;TS.Atoms.Buffer&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BufferAtoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="c1"># Currently Inelastica only accepts the from &lt;&gt; to &lt;&gt;</span>
            <span class="c1"># and from &lt;&gt; plus/minus &lt;&gt;</span>
            <span class="k">if</span> <span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;from&#39;</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">nua</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;plus&#39;</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;minus&#39;</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nua</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sl</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
                        <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
                        <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bufL</span><span class="p">):</span>
            <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nua</span><span class="o">-</span><span class="n">bufR</span><span class="p">,</span> <span class="n">nua</span><span class="p">):</span>
            <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">BufferAtoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="c1"># sort it</span>
    <span class="n">BufferAtoms</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">nbuf</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">BufferAtoms</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">nua</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># They must be consecutive</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nua</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbuf</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">break</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">nbuf</span><span class="p">[</span><span class="n">nbuf</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">nua</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nbuf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Buffer atoms must be consecutive, please correct&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nbuf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">N</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nbuf</span> <span class="o">&lt;=</span> <span class="n">nua</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Buffer atoms does not exist in the TSHS file&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nbuf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">nua</span><span class="o">-</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2003-2018, Magnus Paulsson and Thomas Frederiksen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'v1.3.4',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>